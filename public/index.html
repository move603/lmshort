<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureLink - Modern Link Shortener</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                transform: translateX(-100%);
            }

            to {
                transform: translateX(0);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        @keyframes gradient {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-20px);
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }

            100% {
                background-position: 1000px 0;
            }
        }

        @keyframes mobileMenuSlide {
            from {
                transform: translateX(100%);
            }

            to {
                transform: translateX(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }

        .slide-in {
            animation: slideIn 0.4s ease-out;
        }

        .pulse-animation {
            animation: pulse 2s infinite;
        }

        .float-animation {
            animation: float 3s ease-in-out infinite;
        }

        .mobile-menu-slide {
            animation: mobileMenuSlide 0.3s ease-out;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 200% 200%;
            animation: gradient 15s ease infinite;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }

        .captcha-box {
            border: 2px dashed #667eea;
            padding: 20px;
            border-radius: 12px;
            background: linear-gradient(135deg, #f9fafb 0%, #e0e7ff 100%);
        }

        .link-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 4px solid transparent;
        }

        .link-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px -5px rgba(102, 126, 234, 0.3);
            border-left-color: #667eea;
        }

        .shimmer {
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }

        .stat-card {
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            transform: rotate(45deg);
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }

        .btn-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .neon-text {
            text-shadow: 0 0 10px rgba(102, 126, 234, 0.8),
                0 0 20px rgba(102, 126, 234, 0.6),
                0 0 30px rgba(102, 126, 234, 0.4);
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .container {
                padding: 0 0.75rem;
            }

            .mobile-menu {
                display: block;
            }

            .desktop-menu {
                display: none;
            }

            .mobile-hidden {
                display: none;
            }

            .mobile-full {
                width: 100%;
            }

            .mobile-stack {
                flex-direction: column;
            }

            .mobile-text-center {
                text-align: center;
            }

            .mobile-p-4 {
                padding: 1rem;
            }

            .mobile-mb-4 {
                margin-bottom: 1rem;
            }

            .mobile-space-y-4>*+* {
                margin-top: 1rem;
            }

            .mobile-grid-cols-1 {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }

            .mobile-text-sm {
                font-size: 0.875rem;
            }

            .mobile-text-base {
                font-size: 1rem;
            }

            .mobile-h-12 {
                height: 3rem;
            }

            .mobile-min-h-44 {
                min-height: 11rem;
            }

            /* Enhanced mobile touch targets */
            button,
            .btn-touch,
            input[type="submit"],
            input[type="button"] {
                min-height: 48px;
                min-width: 48px;
                padding: 12px 16px;
                font-size: 16px;
                line-height: 1.2;
            }

            /* Better mobile spacing */
            .mobile-card-spacing {
                margin-bottom: 1.5rem;
            }

            /* Mobile-optimized form inputs */
            input,
            select,
            textarea,
            button {
                font-size: 16px;
                /* Prevent zoom on iOS */
                border-radius: 8px;
            }

            /* Mobile navigation improvements */
            .mobile-nav-btn {
                padding: 12px 16px;
                margin: 4px 0;
                border-radius: 8px;
                font-size: 16px;
            }

            /* Mobile modal improvements */
            .mobile-modal {
                margin: 1rem;
                max-height: 90vh;
                overflow-y: auto;
            }

            /* Mobile grid adjustments */
            .mobile-grid-2 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
                gap: 0.75rem;
            }

            .mobile-grid-1 {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }

            /* Mobile text sizes */
            .mobile-title {
                font-size: 1.5rem;
                line-height: 2rem;
            }

            .mobile-subtitle {
                font-size: 1.125rem;
                line-height: 1.75rem;
            }

            /* Mobile button layouts */
            .mobile-btn-group {
                flex-direction: column;
                gap: 0.5rem;
            }

            .mobile-btn-group button {
                width: 100%;
            }
        }

        @media (min-width: 769px) {
            .mobile-menu {
                display: none;
            }

            .desktop-menu {
                display: flex;
            }
        }

        /* Touch-friendly buttons */
        @media (max-width: 768px) {

            button,
            .btn-touch {
                min-height: 44px;
                min-width: 44px;
                padding: 12px 16px;
                font-size: 16px;
                /* Prevent zoom on iOS */
            }

            input,
            select,
            textarea {
                font-size: 16px;
                /* Prevent zoom on iOS */
            }
        }

        /* Mobile menu overlay */
        .mobile-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .mobile-menu-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .mobile-menu-content {
            position: fixed;
            top: 0;
            right: -300px;
            width: 280px;
            height: 100%;
            background: white;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            transition: right 0.3s ease;
            z-index: 1000;
            padding: 2rem 1rem;
        }

        .mobile-menu-content.active {
            right: 0;
        }

        /* Responsive grid adjustments */
        @media (max-width: 640px) {
            .grid-cols-1.md\\:grid-cols-4 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .grid-cols-1.md\\:grid-cols-3 {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }

            .grid-cols-1.md\\:grid-cols-2 {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }
        }

        @media (max-width: 480px) {
            .grid-cols-1.md\\:grid-cols-4 {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="gradient-bg text-white shadow-lg" id="navbar">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-link text-2xl"></i>
                    <span class="text-2xl font-bold" id="brandName">SecureLink</span>
                </div>

                <!-- Desktop Navigation -->
                <div id="navButtons" class="desktop-menu flex space-x-4"></div>

                <!-- Mobile Menu Button -->
                <button id="mobileMenuBtn"
                    class="mobile-menu md:hidden text-white p-2 rounded-lg hover:bg-white hover:bg-opacity-20 transition">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </div>
        </div>

        <!-- Mobile Menu Overlay -->
        <div id="mobileMenuOverlay" class="mobile-menu-overlay">
            <div class="mobile-menu-content">
                <div class="flex justify-between items-center mb-6">
                    <span class="text-xl font-bold">Menu</span>
                    <button id="closeMobileMenu" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div id="mobileNavButtons" class="space-y-4"></div>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div id="app" class="container mx-auto px-4 py-8"></div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <script>
        // ==================== GLOBAL STATE ====================
        const APP_STATE = {
            currentUser: null,
            currentView: 'home', // Default to Home for Guest Mode
            links: [],
            guestLinks: JSON.parse(localStorage.getItem('guestLinks')) || [],
            settings: JSON.parse(localStorage.getItem('settings')) || {
                brandName: 'SecureLink',
                brandColor: '#667eea',
                logo: null
            },
            captchaVerified: false,
            isLoading: false,
            domains: [] // Store user domains
        };

        // ==================== API FUNCTIONS ====================
        async function fetchUserLinks() {
            if (!APP_STATE.currentUser) return;

            try {
                const response = await fetch('/api/links', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        APP_STATE.links = data.links;
                    }
                }
            } catch (error) {
                console.error('Error fetching user links:', error);
            }
        }

        // ==================== UTILITY FUNCTIONS ====================
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `px-6 py-4 rounded-lg shadow-lg text-white transform transition-all duration-300 ${type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'
                }`;
            toast.innerHTML = `
                <div class="flex items-center space-x-2">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function generateShortCode(length = 6) {
            const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function isValidURL(url) {
            try {
                // Allow URLs with or without protocol, and handle query parameters
                let testUrl = url.trim();
                if (!testUrl.startsWith('http://') && !testUrl.startsWith('https://')) {
                    testUrl = 'https://' + testUrl;
                }
                new URL(testUrl);
                return true;
            } catch (e) {
                return false;
            }
        }

        function isMaliciousURL(url) {
            const maliciousPatterns = ['malware', 'phishing', 'spam', 'scam', 'hack'];
            const lowerUrl = url.toLowerCase();
            return maliciousPatterns.some(pattern => lowerUrl.includes(pattern));
        }

        function saveToLocalStorage() {
            // Only save settings to localStorage, links and users are handled by API
            localStorage.setItem('settings', JSON.stringify(APP_STATE.settings));
        }

        function generateToken() {
            return 'token_' + Math.random().toString(36).substr(2) + Date.now().toString(36);
        }

        function checkLinkExpiry(link) {
            if (!link.expiryTime) return false;
            return new Date() > new Date(link.expiryTime);
        }

        function getDeviceType() {
            const ua = navigator.userAgent;
            if (/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(ua)) {
                return 'Tablet';
            }
            if (/Mobile|Android|iP(hone|od)|IEMobile|BlackBerry|Kindle|Silk-Accelerated|(hpw|web)OS|Opera M(obi|ini)/.test(ua)) {
                return 'Mobile';
            }
            return 'Desktop';
        }

        function generateCaptcha() {
            const num1 = Math.floor(Math.random() * 10);
            const num2 = Math.floor(Math.random() * 10);
            return { num1, num2, answer: num1 + num2 };
        }

        // ==================== AUTHENTICATION ====================
        function renderLogin() {
            const captcha = generateCaptcha();
            APP_STATE.currentCaptcha = captcha;
            APP_STATE.captchaVerified = false;

            return `
                <div class="max-w-md mx-auto mt-16 fade-in">
                    <div class="bg-white rounded-2xl shadow-xl p-8">
                        <div class="text-center mb-8">
                            <i class="fas fa-lock text-6xl gradient-bg bg-clip-text text-transparent mb-4"></i>
                            <h2 class="text-3xl font-bold text-gray-800">Welcome Back</h2>
                            <p class="text-gray-600 mt-2">Sign in to manage your links</p>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Email</label>
                                <input type="email" id="loginEmail" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Enter your email">
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Password</label>
                                <input type="password" id="loginPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Enter your password">
                            </div>

                            <!-- CAPTCHA -->
                            <div class="captcha-box">
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-shield-alt"></i> Security Check
                                </label>
                                <div class="flex items-center space-x-4">
                                    <div class="text-xl font-bold gradient-bg text-white px-4 py-2 rounded">
                                        ${captcha.num1} + ${captcha.num2} = ?
                                    </div>
                                    <input type="number" id="captchaAnswer" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Answer">
                                </div>
                            </div>
                            
                            <button onclick="handleLogin()" class="w-full gradient-bg text-white py-3 rounded-lg font-semibold hover:opacity-90 transition duration-300">
                                <i class="fas fa-sign-in-alt mr-2"></i> Sign In
                            </button>
                            
                            <div class="text-center">
                                <button onclick="switchToSignup()" class="text-purple-600 hover:underline">
                                    Don't have an account? Sign up
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSignup() {
            const captcha = generateCaptcha();
            APP_STATE.currentCaptcha = captcha;
            APP_STATE.captchaVerified = false;

            return `
                <div class="max-w-md mx-auto mt-16 fade-in">
                    <div class="bg-white rounded-2xl shadow-xl p-8">
                        <div class="text-center mb-8">
                            <i class="fas fa-user-plus text-6xl gradient-bg bg-clip-text text-transparent mb-4"></i>
                            <h2 class="text-3xl font-bold text-gray-800">Create Account</h2>
                            <p class="text-gray-600 mt-2">Join SecureLink today</p>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Full Name</label>
                                <input type="text" id="signupName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Enter your name">
                            </div>

                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Email</label>
                                <input type="email" id="signupEmail" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Enter your email">
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Password</label>
                                <input type="password" id="signupPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Create a password">
                            </div>

                            <!-- CAPTCHA -->
                            <div class="captcha-box">
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-shield-alt"></i> Security Check
                                </label>
                                <div class="flex items-center space-x-4">
                                    <div class="text-xl font-bold gradient-bg text-white px-4 py-2 rounded">
                                        ${captcha.num1} + ${captcha.num2} = ?
                                    </div>
                                    <input type="number" id="captchaAnswer" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Answer">
                                </div>
                            </div>
                            
                            <button onclick="handleSignup()" class="w-full gradient-bg text-white py-3 rounded-lg font-semibold hover:opacity-90 transition duration-300">
                                <i class="fas fa-user-check mr-2"></i> Create Account
                            </button>
                            
                            <div class="text-center">
                                <button onclick="switchToLogin()" class="text-purple-600 hover:underline">
                                    Already have an account? Sign in
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const captchaAnswer = parseInt(document.getElementById('captchaAnswer').value);

            if (!email || !password) {
                showToast('Please fill in all fields', 'error');
                return;
            }

            if (captchaAnswer !== APP_STATE.currentCaptcha.answer) {
                showToast('CAPTCHA verification failed', 'error');
                return;
            }

            try {
                const response = await fetch('/api/auth?type=login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email,
                        password,
                        captchaAnswer,
                        captchaCorrect: APP_STATE.currentCaptcha.answer
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    APP_STATE.currentUser = data.user;
                    localStorage.setItem('authToken', data.user.token);

                    // Sync Guest Links
                    const guestLinks = JSON.parse(localStorage.getItem('guestLinks')) || [];
                    if (guestLinks.length > 0) {
                        try {
                            const guestShortCodes = guestLinks.map(l => l.shortCode);
                            await fetch('/api/links?action=sync', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${data.user.token}`
                                },
                                body: JSON.stringify({ shortCodes: guestShortCodes })
                            });
                            localStorage.removeItem('guestLinks'); // Clear after sync
                            APP_STATE.guestLinks = [];
                        } catch (syncError) {
                            console.error('Sync error:', syncError);
                        }
                    }

                    showToast('Login successful!', 'success');
                    await fetchUserLinks();
                    switchToDashboard();
                } else {
                    showToast(data.error || 'Login failed', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showToast('Network error. Please try again.', 'error');
            }
        }

        async function handleSignup() {
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const captchaAnswer = parseInt(document.getElementById('captchaAnswer').value);

            if (!name || !email || !password) {
                showToast('Please fill in all fields', 'error');
                return;
            }

            if (captchaAnswer !== APP_STATE.currentCaptcha.answer) {
                showToast('CAPTCHA verification failed', 'error');
                return;
            }

            try {
                const response = await fetch('/api/auth?type=register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name,
                        email,
                        password,
                        captchaAnswer,
                        captchaCorrect: APP_STATE.currentCaptcha.answer
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    APP_STATE.currentUser = data.user;
                    localStorage.setItem('authToken', data.user.token);
                    showToast('Account created successfully!', 'success');
                    switchToDashboard();
                } else {
                    showToast(data.error || 'Registration failed', 'error');
                }
            } catch (error) {
                console.error('Signup error:', error);
                showToast('Network error. Please try again.', 'error');
            }
        }

        function handleLogout() {
            APP_STATE.currentUser = null;
            APP_STATE.links = [];
            localStorage.removeItem('authToken'); // Ensure token is removed
            showToast('Logged out successfully', 'info');
            switchToLogin();
        }

        // ==================== HOME (GUEST MODE) ====================
        function renderHome() {
            const guestLinks = APP_STATE.guestLinks || [];

            return `
                <div class="fade-in max-w-4xl mx-auto">
                    <!-- Hero Section -->
                    <div class="text-center mb-12 animate-float">
                        <i class="fas fa-link text-6xl gradient-bg bg-clip-text text-transparent mb-4 inline-block"></i>
                        <h1 class="text-4xl md:text-6xl font-black text-gray-800 mb-4 tracking-tight">
                            Shorten Your Links <br>
                            <span class="gradient-bg bg-clip-text text-transparent">Expand Your Reach</span>
                        </h1>
                        <p class="text-xl text-gray-600 mb-8 max-w-2xl mx-auto">
                            Transform long, ugly URLs into short, memorable links. Track clicks, analyze data, and manage your brand.
                        </p>
                        <div class="flex justify-center space-x-4">
                             <button onclick="switchToSignup()" class="bg-gray-800 text-white px-8 py-3 rounded-full font-bold hover:bg-gray-900 transition shadow-lg transform hover:-translate-y-1">
                                Get Started Free
                            </button>
                            <button onclick="document.getElementById('shortener-card').scrollIntoView({behavior: 'smooth'})" class="text-purple-600 font-bold px-8 py-3 rounded-full hover:bg-purple-50 transition">
                                Learn More
                            </button>
                        </div>
                    </div>

                    <!-- Shortener Card -->
                    <div id="shortener-card" class="bg-white rounded-3xl shadow-2xl p-6 md:p-10 mb-12 glass-card border border-purple-100 relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-64 h-64 bg-purple-100 rounded-full mix-blend-multiply filter blur-3xl opacity-30 -mr-32 -mt-32"></div>
                        <div class="absolute bottom-0 left-0 w-64 h-64 bg-blue-100 rounded-full mix-blend-multiply filter blur-3xl opacity-30 -ml-32 -mb-32"></div>

                        <div class="relative z-10">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">
                                <i class="fas fa-magic gradient-bg bg-clip-text text-transparent"></i> Paste your long link here
                            </h2>
                            
                            <div class="flex flex-col md:flex-row gap-4 mb-6">
                                <div class="flex-1">
                                    <div class="relative">
                                        <i class="fas fa-link absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                        <input type="url" id="originalUrl" class="w-full pl-12 pr-4 py-4 border-2 border-gray-100 rounded-xl focus:ring-4 focus:ring-purple-100 focus:border-purple-500 transition text-lg" placeholder="https://example.com/very-long-url-to-shorten">
                                    </div>
                                </div>
                                <button onclick="createLink()" class="gradient-bg text-white px-8 py-4 rounded-xl font-bold hover:shadow-xl transition transform hover:-translate-y-1 flex items-center justify-center min-w-[160px]">
                                    <i class="fas fa-compress-alt mr-2"></i> Shorten
                                </button>
                            </div>

                            <!-- Advanced Options Toggler -->
                            <div class="text-center">
                                <button onclick="document.getElementById('guestOptions').classList.toggle('hidden')" class="text-sm text-gray-500 hover:text-purple-600 transition flex items-center justify-center mx-auto">
                                    <i class="fas fa-sliders-h mr-2"></i> Customize Link (Optional)
                                </button>
                            </div>

                            <div id="guestOptions" class="hidden mt-6 grid grid-cols-1 md:grid-cols-2 gap-4 animate-fade-in-down">
                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2">Custom Alias</label>
                                    <input type="text" id="customAlias" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="my-link">
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2">Expiry</label>
                                    <select id="expiryTime" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500">
                                        <option value="">No Expiry</option>
                                        <option value="60">1 Hour</option>
                                        <option value="1440">24 Hours</option>
                                        <option value="10080">7 Days</option>
                                    </select>
                                </div>
                                <input type="hidden" id="linkPassword" value="">
                                <input type="hidden" id="linkTitle" value="">
                            </div>
                        </div>
                    </div>

                    <!-- Guest Recent Links -->
                    ${guestLinks.length > 0 ? `
                        <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
                            <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                                <i class="fas fa-history mr-2 text-purple-600"></i> Your Recent Links
                            </h3>
                            <div class="space-y-4">
                                ${guestLinks.slice(0, 5).map(link => `
                                    <div class="border border-gray-100 rounded-xl p-4 hover:shadow-md transition bg-gray-50">
                                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center space-x-2 mb-1">
                                                    <a href="/${link.shortCode}" target="_blank" class="text-lg font-bold text-purple-600 hover:underline truncate block">
                                                        ${window.location.origin}/${link.shortCode}
                                                    </a>
                                                    <button onclick="copyToClipboard('${window.location.origin}/${link.shortCode}')" class="text-gray-400 hover:text-purple-600">
                                                        <i class="fas fa-copy"></i>
                                                    </button>
                                                </div>
                                                <p class="text-sm text-gray-500 truncate">${link.originalUrl}</p>
                                            </div>
                                            <div class="flex items-center space-x-3 w-full md:w-auto">
                                                <button onclick="showQRCode('${link.shortCode}')" class="flex-1 md:flex-none bg-blue-100 text-blue-600 px-4 py-2 rounded-lg hover:bg-blue-200 transition font-medium text-sm">
                                                    <i class="fas fa-qrcode mr-1"></i> QR
                                                </button>
                                                <span class="text-xs text-gray-400 bg-gray-100 px-3 py-1 rounded-full whitespace-nowrap">
                                                    Guest Link
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="mt-6 text-center bg-purple-50 rounded-xl p-4">
                                <p class="text-purple-800 text-sm">
                                    <i class="fas fa-info-circle mr-1"></i> 
                                    <a href="#" onclick="switchToLogin()" class="font-bold hover:underline">Log in</a> 
                                    to save these links permanently and see analytics!
                                </p>
                            </div>
                        </div>
                    ` : ''}

                    <!-- Features Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mt-12 mb-12">
                        <div class="text-center p-6 rounded-2xl bg-white shadow-sm hover:shadow-md transition">
                            <div class="w-16 h-16 bg-blue-100 rounded-2xl flex items-center justify-center mx-auto mb-4 text-blue-600 text-2xl">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <h3 class="font-bold text-lg mb-2">Analytics</h3>
                            <p class="text-gray-500 text-sm">Track clicks and know your audience.</p>
                        </div>
                        <div class="text-center p-6 rounded-2xl bg-white shadow-sm hover:shadow-md transition">
                            <div class="w-16 h-16 bg-purple-100 rounded-2xl flex items-center justify-center mx-auto mb-4 text-purple-600 text-2xl">
                                <i class="fas fa-globe"></i>
                            </div>
                            <h3 class="font-bold text-lg mb-2">Custom Domains</h3>
                            <p class="text-gray-500 text-sm">Use your own domain for branding.</p>
                        </div>
                        <div class="text-center p-6 rounded-2xl bg-white shadow-sm hover:shadow-md transition">
                            <div class="w-16 h-16 bg-green-100 rounded-2xl flex items-center justify-center mx-auto mb-4 text-green-600 text-2xl">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <h3 class="font-bold text-lg mb-2">Secure & Reliable</h3>
                            <p class="text-gray-500 text-sm">HTTPS encryption and 99.9% uptime.</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== DASHBOARD ====================
        function renderDashboard() {
            const userLinks = APP_STATE.links.filter(l => l.userId === APP_STATE.currentUser.id);
            const activeLinks = userLinks.filter(l => !checkLinkExpiry(l));
            const totalClicks = userLinks.reduce((sum, l) => sum + (l.clicks || 0), 0);
            const expiredLinks = userLinks.filter(l => checkLinkExpiry(l));

            return `
                <div class="fade-in">
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 mobile:grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 mb-6 md:mb-8">
                        <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 link-card mobile-card-spacing">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <p class="text-gray-600 text-xs md:text-sm font-semibold">Total Links</p>
                                    <p class="text-2xl md:text-3xl font-bold text-gray-800 mt-1 md:mt-2">${userLinks.length}</p>
                                </div>
                                <div class="bg-blue-100 p-3 md:p-4 rounded-full ml-3">
                                    <i class="fas fa-link text-blue-600 text-xl md:text-2xl"></i>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 link-card mobile-card-spacing">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <p class="text-gray-600 text-xs md:text-sm font-semibold">Active Links</p>
                                    <p class="text-2xl md:text-3xl font-bold text-green-600 mt-1 md:mt-2">${activeLinks.length}</p>
                                </div>
                                <div class="bg-green-100 p-3 md:p-4 rounded-full ml-3">
                                    <i class="fas fa-check-circle text-green-600 text-xl md:text-2xl"></i>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 link-card mobile-card-spacing">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <p class="text-gray-600 text-xs md:text-sm font-semibold">Total Clicks</p>
                                    <p class="text-2xl md:text-3xl font-bold text-purple-600 mt-1 md:mt-2">${totalClicks}</p>
                                </div>
                                <div class="bg-purple-100 p-3 md:p-4 rounded-full ml-3">
                                    <i class="fas fa-mouse-pointer text-purple-600 text-xl md:text-2xl"></i>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 link-card mobile-card-spacing">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <p class="text-gray-600 text-xs md:text-sm font-semibold">Expired Links</p>
                                    <p class="text-2xl md:text-3xl font-bold text-red-600 mt-1 md:mt-2">${expiredLinks.length}</p>
                                </div>
                                <div class="bg-red-100 p-3 md:p-4 rounded-full ml-3">
                                    <i class="fas fa-clock text-red-600 text-xl md:text-2xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Create New Link -->
                    <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
                        <h3 class="text-2xl font-bold text-gray-800 mb-6">
                            <i class="fas fa-plus-circle gradient-bg bg-clip-text text-transparent"></i> Create New Link
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="md:col-span-2">
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-globe"></i> Original URL
                                </label>
                                <input type="url" id="originalUrl" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="https://example.com/very-long-url">
                            </div>

                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-tag"></i> Custom Alias (Optional)
                                </label>
                                <div class="flex">
                                    <div class="relative">
                                        <select id="domainSelect" class="appearance-none bg-gray-50 border border-gray-300 text-gray-700 py-3 pl-4 pr-8 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-purple-500 border-r-0 h-full">
                                            <option value="">${window.location.hostname}/</option>
                                            ${APP_STATE.domains && APP_STATE.domains.filter(d => d.verified).map(d => `
                                                <option value="${d.id}">${d.domain}/</option>
                                            `).join('')}
                                        </select>
                                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                            <i class="fas fa-chevron-down text-xs"></i>
                                        </div>
                                    </div>
                                    <input type="text" id="customAlias" class="flex-1 px-4 py-3 border border-gray-300 rounded-r-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="alias">
                                </div>
                            </div>

                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-clock"></i> Expiry Time
                                </label>
                                <select id="expiryTime" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                    <option value="">No Expiry</option>
                                    <option value="5">5 Minutes</option>
                                    <option value="10">10 Minutes</option>
                                    <option value="30">30 Minutes</option>
                                    <option value="60">1 Hour</option>
                                    <option value="1440">24 Hours</option>
                                    <option value="10080">7 Days</option>
                                    <option value="custom">Custom Date/Time</option>
                                </select>
                            </div>

                            <div id="customExpiryContainer" class="hidden md:col-span-2">
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-calendar-alt"></i> Custom Expiry Date & Time
                                </label>
                                <input type="datetime-local" id="customExpiryDate" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>

                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-lock"></i> Password Protection (Optional)
                                </label>
                                <input type="password" id="linkPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Set a password">
                            </div>

                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-image"></i> Link Title (Optional)
                                </label>
                                <input type="text" id="linkTitle" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="My Link">
                            </div>
                        </div>

                        <button onclick="createLink()" class="mt-6 gradient-bg text-white px-8 py-3 rounded-lg font-semibold hover:opacity-90 transition duration-300 pulse-animation">
                            <i class="fas fa-magic mr-2"></i> Generate Short Link
                        </button>
                    </div>

                    <!-- Links List -->
                    <div class="bg-white rounded-xl shadow-lg p-4 md:p-8">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 space-y-4 md:space-y-0">
                            <h3 class="text-xl md:text-2xl font-bold text-gray-800">
                                <i class="fas fa-list"></i> Your Links
                            </h3>
                            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3 w-full md:w-auto">
                                <button id="deleteSelectedBtn" onclick="deleteSelectedLinks()" class="hidden bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition font-semibold text-sm md:text-base">
                                    <i class="fas fa-trash-alt mr-2"></i> Delete Selected (<span id="selectedCount">0</span>)
                                </button>
                                <button onclick="exportLinks()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition font-semibold text-sm md:text-base">
                                    <i class="fas fa-download mr-2"></i> Export
                                </button>
                                <a href="/links" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90 transition font-semibold text-center text-sm md:text-base">
                                    <i class="fas fa-list mr-2"></i> View All
                                </a>
                            </div>
                        </div>

                        <div class="space-y-4 custom-scrollbar max-h-96 overflow-y-auto" id="linksList">
                            ${renderLinksList(userLinks)}
                        </div>
                    </div>
                </div>
            `;
        }

        // Selected links state
        let selectedLinkIds = new Set();

        function renderLinksList(links) {
            if (links.length === 0) {
                return `
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-inbox text-6xl mb-4"></i>
                        <p class="text-xl">No links created yet</p>
                    </div>
                `;
            }

            const selectAllChecked = selectedLinkIds.size === links.length && links.length > 0;

            return `
                <!-- Select All Checkbox -->
                <div class="flex items-center justify-between p-4 bg-purple-50 rounded-lg mb-4 border-2 border-purple-200">
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input 
                            type="checkbox" 
                            id="selectAll" 
                            ${selectAllChecked ? 'checked' : ''} 
                            onchange="toggleSelectAll(this.checked)"
                            class="w-5 h-5 text-purple-600 rounded focus:ring-2 focus:ring-purple-500 cursor-pointer"
                        >
                        <span class="font-semibold text-purple-800">
                            <i class="fas fa-check-double mr-2"></i>Select All Links
                        </span>
                    </label>
                    <span class="text-sm text-purple-700 font-medium">
                        ${selectedLinkIds.size} of ${links.length} selected
                    </span>
                </div>

                <!-- Links -->
                ${links.map(link => {
                const isExpired = checkLinkExpiry(link);
                const shortUrl = `${window.location.origin}/${link.shortCode}`;
                const isSelected = selectedLinkIds.has(link.id);

                return `
                        <div class="border-2 ${isSelected ? 'border-purple-500 bg-purple-50' : 'border-gray-200 bg-gray-50'} rounded-lg p-4 link-card ${isExpired ? 'opacity-60' : ''} transition-all duration-200">
                            <div class="flex items-start space-x-3">
                                <!-- Checkbox -->
                                <input 
                                    type="checkbox" 
                                    ${isSelected ? 'checked' : ''} 
                                    onchange="toggleLinkSelection('${link.id}', this.checked)"
                                    class="w-5 h-5 mt-1 text-purple-600 rounded focus:ring-2 focus:ring-purple-500 cursor-pointer"
                                >
                                
                                <!-- Link Content -->
                                <div class="flex-1">
                                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center space-y-3 md:space-y-0">
                                        <div class="flex-1">
                                            <div class="flex items-center space-x-2 mb-2">
                                                ${link.title ? `<h4 class="font-semibold text-gray-800">${link.title}</h4>` : ''}
                                                ${isExpired ? '<span class="bg-red-500 text-white px-2 py-1 rounded text-xs">Expired</span>' : '<span class="bg-green-500 text-white px-2 py-1 rounded text-xs">Active</span>'}
                                                ${link.password ? '<i class="fas fa-lock text-yellow-600" title="Password Protected"></i>' : ''}
                                            </div>
                                            <p class="text-sm text-gray-600 mb-1 break-all">
                                                <i class="fas fa-link text-purple-600"></i> <strong>Short:</strong> 
                                                <a href="#" onclick="openLink('${link.shortCode}')" class="text-purple-600 hover:underline">${shortUrl}</a>
                                            </p>
                                            <p class="text-xs text-gray-500 break-all">
                                                <i class="fas fa-external-link-alt"></i> <strong>Original:</strong> ${link.originalUrl}
                                            </p>
                                            <div class="flex items-center space-x-4 mt-2 text-xs text-gray-600">
                                                <span><i class="fas fa-mouse-pointer"></i> ${link.clicks || 0} clicks</span>
                                                ${link.expiryTime ? `<span><i class="fas fa-clock"></i> Expires: ${new Date(link.expiryTime).toLocaleString()}</span>` : ''}
                                            </div>
                                        </div>
                                        
                                        <div class="flex flex-wrap gap-2 mt-3 md:mt-0">
                                            <button onclick="copyToClipboard('${shortUrl}')" class="flex-1 md:flex-none bg-blue-500 text-white px-3 py-3 md:px-4 md:py-2 rounded-lg hover:bg-blue-600 transition shadow-sm btn-touch" title="Copy">
                                                <i class="fas fa-copy mr-1 md:mr-0"></i><span class="hidden md:inline"> Copy</span>
                                            </button>
                                            <button onclick="showQRCode('${link.shortCode}')" class="flex-1 md:flex-none bg-purple-500 text-white px-3 py-3 md:px-4 md:py-2 rounded-lg hover:bg-purple-600 transition shadow-sm btn-touch" title="QR Code">
                                                <i class="fas fa-qrcode mr-1 md:mr-0"></i><span class="hidden md:inline"> QR</span>
                                            </button>
                                            <button onclick="viewLinkAnalytics('${link.id}')" class="flex-1 md:flex-none bg-green-500 text-white px-3 py-3 md:px-4 md:py-2 rounded-lg hover:bg-green-600 transition shadow-sm btn-touch" title="Analytics">
                                                <i class="fas fa-chart-line mr-1 md:mr-0"></i><span class="hidden md:inline"> Stats</span>
                                            </button>
                                            <button onclick="editLink('${link.id}')" class="flex-1 md:flex-none bg-yellow-500 text-white px-3 py-3 md:px-4 md:py-2 rounded-lg hover:bg-yellow-600 transition shadow-sm btn-touch" title="Edit">
                                                <i class="fas fa-edit mr-1 md:mr-0"></i><span class="hidden md:inline"> Edit</span>
                                            </button>
                                            <button onclick="deleteLink('${link.id}')" class="flex-1 md:flex-none bg-red-500 text-white px-3 py-3 md:px-4 md:py-2 rounded-lg hover:bg-red-600 transition shadow-sm btn-touch" title="Delete">
                                                <i class="fas fa-trash mr-1 md:mr-0"></i><span class="hidden md:inline"> Delete</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
            }).join('')}
            `;
        }

        function toggleLinkSelection(linkId, isChecked) {
            if (isChecked) {
                selectedLinkIds.add(linkId);
            } else {
                selectedLinkIds.delete(linkId);
            }
            updateDeleteButton();
        }

        function toggleSelectAll(isChecked) {
            const userLinks = APP_STATE.links.filter(l => l.userId === APP_STATE.currentUser.id);

            if (isChecked) {
                userLinks.forEach(link => selectedLinkIds.add(link.id));
            } else {
                selectedLinkIds.clear();
            }

            render();
        }

        function updateDeleteButton() {
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            const countSpan = document.getElementById('selectedCount');

            if (deleteBtn && countSpan) {
                countSpan.textContent = selectedLinkIds.size;

                if (selectedLinkIds.size > 0) {
                    deleteBtn.classList.remove('hidden');
                } else {
                    deleteBtn.classList.add('hidden');
                }
            }
        }

        async function deleteSelectedLinks() {
            if (selectedLinkIds.size === 0) {
                showToast('No links selected', 'error');
                return;
            }

            const count = selectedLinkIds.size;
            const confirmed = confirm(`Are you sure you want to delete ${count} selected link${count > 1 ? 's' : ''}? This action cannot be undone.`);

            if (confirmed) {
                try {
                    const response = await fetch('/api/links?action=bulk-delete', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: JSON.stringify({
                            linkIds: Array.from(selectedLinkIds)
                        })
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        // Real-time update: Remove deleted links from state
                        APP_STATE.links = APP_STATE.links.filter(l => !selectedLinkIds.has(l.id));
                        selectedLinkIds.clear();
                        showToast(`Successfully deleted ${data.deleted} link${data.deleted > 1 ? 's' : ''}!`, 'success');
                        render(); // Instant UI update with new counters
                    } else {
                        showToast(data.error || 'Failed to delete links', 'error');
                    }
                } catch (error) {
                    console.error('Bulk delete error:', error);
                    showToast('Network error. Please try again.', 'error');
                }
            }
        }

        async function createLink() {
            const originalUrl = document.getElementById('originalUrl').value;
            const customAlias = document.getElementById('customAlias').value;
            const expiryTime = document.getElementById('expiryTime').value;
            const linkPassword = document.getElementById('linkPassword').value;
            const linkTitle = document.getElementById('linkTitle').value;
            const domainSelect = document.getElementById('domainSelect');
            const domainId = domainSelect ? domainSelect.value : null;

            if (!originalUrl) {
                showToast('Please enter a URL', 'error');
                return;
            }

            if (!isValidURL(originalUrl)) {
                showToast('Please enter a valid URL', 'error');
                return;
            }

            if (isMaliciousURL(originalUrl)) {
                showToast('This URL has been flagged as potentially malicious and cannot be shortened', 'error');
                return;
            }

            let expiryDateTime = null;
            if (expiryTime === 'custom') {
                const customDate = document.getElementById('customExpiryDate').value;
                if (!customDate) {
                    showToast('Please select a custom expiry date', 'error');
                    return;
                }
                expiryDateTime = new Date(customDate).toISOString();
            } else if (expiryTime) {
                expiryDateTime = new Date(Date.now() + parseInt(expiryTime) * 60000).toISOString();
            }

            try {
                const authToken = localStorage.getItem('authToken');
                const headers = { 'Content-Type': 'application/json' };
                if (authToken) headers['Authorization'] = `Bearer ${authToken}`;

                const response = await fetch('/api/links', {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({
                        originalUrl,
                        customAlias,
                        title: linkTitle,
                        password: linkPassword,
                        expiryTime: expiryDateTime,
                        domainId
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Update state
                    if (APP_STATE.currentUser) {
                        if (!APP_STATE.links) APP_STATE.links = [];
                        APP_STATE.links.unshift(data.link);
                    } else {
                        // Guest mode: Save to local storage
                        if (!APP_STATE.guestLinks) APP_STATE.guestLinks = [];
                        APP_STATE.guestLinks.unshift(data.link);
                        localStorage.setItem('guestLinks', JSON.stringify(APP_STATE.guestLinks));
                    }

                    // Clear form
                    const inputs = ['originalUrl', 'customAlias', 'expiryTime', 'linkPassword', 'linkTitle'];
                    inputs.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.value = '';
                    });
                    if (document.getElementById('domainSelect')) document.getElementById('domainSelect').selectedIndex = 0;

                    // Determine short URL based on domain
                    let shortUrl = '';
                    if (data.link.domain) {
                        // If backend returns populated domain, good. If not, we might need to construct it?
                        // The create API returns `link` object. Does it include domain info?
                        // I only added `domainId` to prisma create. Prisma result includes only local fields by default unless `include` is used.
                        // But the Dashboard uses `window.location.origin`. Guest uses origin.
                        // For custom domain, we should use that domain.

                        // Wait, if I created it with a custom domain, the returned link object has `domainId`.
                        // I need to know the domain name to display it.
                        // The backend `create.js` returns simple fields.
                        // I should update `create.js` to include `domain` relation if possible, or I look it up from APP_STATE.domains here.

                        const usedDomain = APP_STATE.domains ? APP_STATE.domains.find(d => d.id === data.link.domainId) : null;
                        if (usedDomain) {
                            shortUrl = `https://${usedDomain.domain}/${data.link.shortCode}`;
                        } else {
                            shortUrl = `${window.location.origin}/${data.link.shortCode}`;
                        }
                    } else {
                        shortUrl = `${window.location.origin}/${data.link.shortCode}`;
                    }

                    // Show elegant popup modal with link details
                    showCreatedLinkModal(shortUrl, data.link.shortCode);

                    // Re-render to show the new link immediately (real-time update)
                    render();
                } else {
                    showToast(data.error || 'Failed to create link', 'error');
                }
            } catch (error) {
                console.error('Create link error:', error);
                showToast('Network error. Please try again.', 'error');
            }
        }

        // Show elegant created link modal with QR code, copy button, and share options
        function showCreatedLinkModal(shortUrl, shortCode) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

            modal.innerHTML = `
                <div class="bg-white rounded-3xl p-6 md:p-10 max-w-lg w-full mx-4 fade-in shadow-2xl transform" onclick="event.stopPropagation()">
                    <div class="text-center">
                        <!-- Success Icon -->
                        <div class="mb-6">
                            <div class="w-20 h-20 bg-gradient-to-br from-green-400 to-green-600 rounded-full flex items-center justify-center mx-auto mb-4 pulse-animation">
                                <i class="fas fa-check text-white text-4xl"></i>
                            </div>
                            <h3 class="text-3xl font-bold gradient-bg bg-clip-text text-transparent mb-2">Link Created!</h3>
                            <p class="text-gray-600">Your shortened link is ready to share</p>
                        </div>
                        
                        <!-- Shortened URL Display -->
                        <div class="bg-gradient-to-r from-purple-50 to-blue-50 border-2 border-purple-200 rounded-2xl p-5 mb-6">
                            <p class="text-sm text-gray-600 mb-2 font-semibold">Your Shortened URL:</p>
                            <p class="text-xl font-bold text-purple-700 break-all mb-4">${shortUrl}</p>
                            <button onclick="copyToClipboard('${shortUrl}'); showToast('Copied to clipboard! ', 'success');" class="w-full gradient-bg text-white px-6 py-3 rounded-xl hover:shadow-xl transition font-bold text-lg">
                                <i class="fas fa-copy mr-2"></i> Copy Link
                            </button>
                        </div>
                        
                        <!-- QR Code Section -->
                        <div class="bg-gray-50 rounded-2xl p-6 mb-6">
                            <p class="text-sm text-gray-600 mb-3 font-semibold">QR Code:</p>
                            <div id="modalQrcodeContainer" class="flex justify-center mb-4"></div>
                            <button onclick="downloadQRCodeFromModal('${shortCode}')" class="w-full bg-blue-600 text-white px-6 py-3 rounded-xl hover:bg-blue-700 transition font-semibold">
                                <i class="fas fa-download mr-2"></i> Download QR Code
                            </button>
                        </div>
                        
                        <!-- Share Options -->
                        <div class="grid grid-cols-2 gap-3 mb-6">
                            <button onclick="shareToTwitter('${shortUrl}')" class="bg-blue-400 text-white px-4 py-3 rounded-xl hover:bg-blue-500 transition font-semibold">
                                <i class="fab fa-twitter mr-2"></i> Twitter
                            </button>
                            <button onclick="shareToWhatsApp('${shortUrl}')" class="bg-green-500 text-white px-4 py-3 rounded-xl hover:bg-green-600 transition font-semibold">
                                <i class="fab fa-whatsapp mr-2"></i> WhatsApp
                            </button>
                        </div>
                        
                        <!-- Close Button -->
                        <button onclick="this.closest('.fixed').remove()" class="w-full bg-gray-500 text-white px-6 py-3 rounded-xl hover:bg-gray-600 transition font-bold text-lg">
                            <i class="fas fa-times mr-2"></i> Close
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Generate QR code
            setTimeout(() => {
                new QRCode(document.getElementById('modalQrcodeContainer'), {
                    text: shortUrl,
                    width: 200,
                    height: 200,
                    colorDark: '#667eea',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
            }, 100);
        }

        // Download QR code from modal
        function downloadQRCodeFromModal(shortCode) {
            const canvas = document.querySelector('#modalQrcodeContainer canvas');
            if (canvas) {
                const url = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = `qr-code-${shortCode}.png`;
                link.href = url;
                link.click();
                showToast('QR Code downloaded!', 'success');
            }
        }

        // Share to Twitter
        function shareToTwitter(url) {
            const text = encodeURIComponent(`Check out this link: ${url}`);
            window.open(`https://twitter.com/intent/tweet?text=${text}`, '_blank', 'width=600,height=400');
        }

        // Share to WhatsApp
        function shareToWhatsApp(url) {
            const text = encodeURIComponent(`Check out this link: ${url}`);
            window.open(`https://wa.me/?text=${text}`, '_blank');
        }

        async function deleteLink(linkId) {
            // Show confirmation with details
            if (!confirm(' Delete this link?\n\nThis action cannot be undone!')) {
                return;
            }

            try {
                // Use correct API endpoint: /api/links/[id]
                const response = await fetch(`/api/links?id=${linkId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Real-time update: Remove from state and re-render
                    APP_STATE.links = APP_STATE.links.filter(l => l.id !== linkId);
                    showToast(' Link deleted successfully!', 'success');
                    render(); // Instant UI update with new counters
                } else {
                    showToast(data.error || 'Failed to delete link', 'error');
                }
            } catch (error) {
                console.error('Delete link error:', error);
                showToast('Network error. Please try again.', 'error');
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied to clipboard!', 'success');
            });
        }

        function exportLinks() {
            const userLinks = APP_STATE.links.filter(l => l.userId === APP_STATE.currentUser.id);
            const csvContent = [
                ['Title', 'Short URL', 'Original URL', 'Clicks', 'Created', 'Expires', 'Status'],
                ...userLinks.map(link => [
                    link.title || '',
                    `${window.location.origin}/${link.shortCode}`,
                    link.originalUrl,
                    link.clicks || 0,
                    new Date(link.createdAt).toLocaleDateString(),
                    link.expiryTime ? new Date(link.expiryTime).toLocaleDateString() : 'Never',
                    checkLinkExpiry(link) ? 'Expired' : 'Active'
                ])
            ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'links-export.csv';
            a.click();
            window.URL.revokeObjectURL(url);
            showToast('Links exported successfully!', 'success');
        }

        function showQRCode(shortCode) {
            const link = APP_STATE.links.find(l => l.shortCode === shortCode);
            const shortUrl = `${window.location.origin}/${shortCode}`;

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 fade-in">
                    <div class="text-center">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">QR Code</h3>
                        <div id="qrcodeContainer" class="flex justify-center mb-4"></div>
                        <p class="text-sm text-gray-600 mb-2 break-all">${shortUrl}</p>
                        <button onclick="this.closest('.fixed').remove()" class="gradient-bg text-white px-6 py-2 rounded-lg hover:opacity-90 transition">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            new QRCode(document.getElementById('qrcodeContainer'), {
                text: shortUrl,
                width: 256,
                height: 256
            });
        }

        function openLink(shortCode) {
            // Use API redirect instead of local logic
            window.open(`/${shortCode}`, '_blank');
            showToast('Redirecting...', 'info');
        }

        async function editLink(linkId) {
            const link = APP_STATE.links.find(l => l.id === linkId);
            if (!link) return;

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 fade-in">
                    <div class="text-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">
                            <i class="fas fa-edit gradient-bg bg-clip-text text-transparent"></i> Edit Link
                        </h3>
                        <p class="text-sm text-gray-600">${window.location.origin}/${link.shortCode}</p>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">
                                <i class="fas fa-tag"></i> Title (Optional)
                            </label>
                            <input type="text" id="editTitle" value="${link.title || ''}" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Link title">
                        </div>

                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">
                                <i class="fas fa-lock"></i> Password (Optional)
                            </label>
                            <input type="password" id="editPassword" value="${link.password || ''}" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Set a password">
                        </div>

                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">
                                <i class="fas fa-clock"></i> Expiry Time
                            </label>
                            <select id="editExpiryTime" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="">No Expiry</option>
                                <option value="5">5 Minutes</option>
                                <option value="10">10 Minutes</option>
                                <option value="30">30 Minutes</option>
                                <option value="60">1 Hour</option>
                                <option value="1440">24 Hours</option>
                                <option value="10080">7 Days</option>
                                <option value="custom">Custom Date/Time</option>
                            </select>
                        </div>

                        <div id="editCustomExpiryContainer" class="hidden">
                            <label class="block text-gray-700 font-semibold mb-2">
                                <i class="fas fa-calendar-alt"></i> Custom Expiry Date & Time
                            </label>
                            <input type="datetime-local" id="editCustomExpiryDate" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                    </div>

                    <div class="flex space-x-3 mt-6">
                        <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition">
                            Cancel
                        </button>
                        <button onclick="saveLinkEdit('${linkId}')" class="flex-1 gradient-bg text-white px-6 py-2 rounded-lg hover:opacity-90 transition">
                            <i class="fas fa-save mr-2"></i> Save Changes
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Set current expiry value
            const expirySelect = document.getElementById('editExpiryTime');
            if (link.expiryTime) {
                const expiryDate = new Date(link.expiryTime);
                const now = new Date();
                const diffMinutes = Math.floor((expiryDate - now) / (1000 * 60));

                if (diffMinutes <= 5) expirySelect.value = '5';
                else if (diffMinutes <= 10) expirySelect.value = '10';
                else if (diffMinutes <= 30) expirySelect.value = '30';
                else if (diffMinutes <= 60) expirySelect.value = '60';
                else if (diffMinutes <= 1440) expirySelect.value = '1440';
                else if (diffMinutes <= 10080) expirySelect.value = '10080';
                else {
                    expirySelect.value = 'custom';
                    document.getElementById('editCustomExpiryContainer').classList.remove('hidden');
                    document.getElementById('editCustomExpiryDate').value = expiryDate.toISOString().slice(0, 16);
                }
            }

            // Add event listener for custom expiry selection
            expirySelect.addEventListener('change', function () {
                const customContainer = document.getElementById('editCustomExpiryContainer');
                if (this.value === 'custom') {
                    customContainer.classList.remove('hidden');
                } else {
                    customContainer.classList.add('hidden');
                }
            });
        }

        async function saveLinkEdit(linkId) {
            const title = document.getElementById('editTitle').value;
            const password = document.getElementById('editPassword').value;
            const expiryTime = document.getElementById('editExpiryTime').value;

            let expiryDateTime = null;
            if (expiryTime === 'custom') {
                const customDate = document.getElementById('editCustomExpiryDate').value;
                if (!customDate) {
                    showToast('Please select a custom expiry date', 'error');
                    return;
                }
                expiryDateTime = new Date(customDate).toISOString();
            } else if (expiryTime) {
                expiryDateTime = new Date(Date.now() + parseInt(expiryTime) * 60000).toISOString();
            }

            try {
                const response = await fetch(`/api/links?id=${linkId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        title,
                        password,
                        expiryTime: expiryDateTime
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Update the link in APP_STATE
                    const linkIndex = APP_STATE.links.findIndex(l => l.id === linkId);
                    if (linkIndex !== -1) {
                        APP_STATE.links[linkIndex] = { ...APP_STATE.links[linkIndex], ...data.link };
                    }

                    showToast('Link updated successfully!', 'success');
                    document.querySelector('.fixed').remove();
                    render();
                } else {
                    showToast(data.error || 'Failed to update link', 'error');
                }
            } catch (error) {
                console.error('Update link error:', error);
                showToast('Network error. Please try again.', 'error');
            }
        }

        // ==================== ANALYTICS ====================
        function renderAnalytics() {
            const userLinks = APP_STATE.links.filter(l => l.userId === APP_STATE.currentUser.id);

            return `
                <div class="fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">
                            <i class="fas fa-chart-bar gradient-bg bg-clip-text text-transparent"></i> Analytics Dashboard
                        </h2>
                        <button onclick="switchToDashboard()" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90 transition">
                            <i class="fas fa-arrow-left mr-2"></i> Back to Dashboard
                        </button>
                    </div>

                    <!-- Overall Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        ${renderOverallStats(userLinks)}
                    </div>

                    <!-- Charts -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Clicks Over Time</h3>
                            <canvas id="clicksChart"></canvas>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Device Distribution</h3>
                            <canvas id="deviceChart"></canvas>
                        </div>
                    </div>

                    <!-- Top Links -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Top Performing Links</h3>
                        ${renderTopLinks(userLinks)}
                    </div>
                </div>
            `;
        }

        function renderOverallStats(links) {
            const totalClicks = links.reduce((sum, l) => sum + (l.clicks || 0), 0);
            const avgCTR = links.length > 0 ? (totalClicks / links.length).toFixed(2) : 0;
            const mostClicked = links.reduce((max, l) => (l.clicks || 0) > (max.clicks || 0) ? l : max, {});

            return `
                <div class="bg-gradient-to-br from-purple-500 to-purple-700 rounded-xl shadow-lg p-6 text-white">
                    <i class="fas fa-mouse-pointer text-3xl mb-2"></i>
                    <p class="text-sm font-semibold opacity-90">Total Clicks</p>
                    <p class="text-4xl font-bold mt-2">${totalClicks}</p>
                </div>
                
                <div class="bg-gradient-to-br from-blue-500 to-blue-700 rounded-xl shadow-lg p-6 text-white">
                    <i class="fas fa-chart-line text-3xl mb-2"></i>
                    <p class="text-sm font-semibold opacity-90">Average CTR</p>
                    <p class="text-4xl font-bold mt-2">${avgCTR}</p>
                </div>
                
                <div class="bg-gradient-to-br from-green-500 to-green-700 rounded-xl shadow-lg p-6 text-white">
                    <i class="fas fa-star text-3xl mb-2"></i>
                    <p class="text-sm font-semibold opacity-90">Most Clicked</p>
                    <p class="text-2xl font-bold mt-2 truncate">${mostClicked.shortCode || 'N/A'}</p>
                    <p class="text-sm opacity-90">${mostClicked.clicks || 0} clicks</p>
                </div>
            `;
        }

        function renderTopLinks(links) {
            const sorted = links.sort((a, b) => (b.clicks || 0) - (a.clicks || 0)).slice(0, 5);

            if (sorted.length === 0) {
                return '<p class="text-gray-500 text-center py-8">No data available</p>';
            }

            return `
                <div class="space-y-3">
                    ${sorted.map((link, index) => `
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                            <div class="flex items-center space-x-4">
                                <div class="bg-purple-100 text-purple-700 w-8 h-8 rounded-full flex items-center justify-center font-bold">
                                    ${index + 1}
                                </div>
                                <div>
                                    <p class="font-semibold text-gray-800">${link.title || link.shortCode}</p>
                                    <p class="text-sm text-gray-500">${window.location.origin}/${link.shortCode}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-2xl font-bold text-purple-600">${link.clicks || 0}</p>
                                <p class="text-xs text-gray-500">clicks</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function viewLinkAnalytics(linkId) {
            const link = APP_STATE.links.find(l => l.id === linkId);
            if (!link) return;

            const analytics = link.analytics || [];
            const devices = analytics.reduce((acc, a) => {
                acc[a.device] = (acc[a.device] || 0) + 1;
                return acc;
            }, {});

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-8 max-w-4xl w-full mx-4 my-8 fade-in">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">
                        <i class="fas fa-chart-pie gradient-bg bg-clip-text text-transparent"></i> 
                        Link Analytics: ${link.title || link.shortCode}
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-purple-50 p-4 rounded-lg text-center">
                            <i class="fas fa-mouse-pointer text-purple-600 text-2xl mb-2"></i>
                            <p class="text-sm text-gray-600">Total Clicks</p>
                            <p class="text-3xl font-bold text-purple-700">${link.clicks || 0}</p>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg text-center">
                            <i class="fas fa-desktop text-blue-600 text-2xl mb-2"></i>
                            <p class="text-sm text-gray-600">Desktop</p>
                            <p class="text-3xl font-bold text-blue-700">${devices['Desktop'] || 0}</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg text-center">
                            <i class="fas fa-mobile-alt text-green-600 text-2xl mb-2"></i>
                            <p class="text-sm text-gray-600">Mobile</p>
                            <p class="text-3xl font-bold text-green-700">${devices['Mobile'] || 0}</p>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h4 class="font-semibold text-gray-800 mb-3">Recent Activity</h4>
                        <div class="max-h-64 overflow-y-auto custom-scrollbar">
                            ${analytics.length > 0 ? analytics.slice(-10).reverse().map(a => `
                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg mb-2">
                                    <div class="flex items-center space-x-3">
                                        <i class="fas fa-${a.device === 'Mobile' ? 'mobile-alt' : a.device === 'Tablet' ? 'tablet-alt' : 'desktop'} text-gray-600"></i>
                                        <div>
                                            <p class="text-sm font-semibold text-gray-800">${a.device}</p>
                                            <p class="text-xs text-gray-500">${new Date(a.timestamp).toLocaleString()}</p>
                                        </div>
                                    </div>
                                    <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">${a.referrer}</span>
                                </div>
                            `).join('') : '<p class="text-gray-500 text-center py-4">No analytics data yet</p>'}
                        </div>
                    </div>
                    
                    <button onclick="this.closest('.fixed').remove()" class="gradient-bg text-white px-6 py-2 rounded-lg hover:opacity-90 transition">
                        Close
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function initializeCharts() {
            const userLinks = APP_STATE.links.filter(l => l.userId === APP_STATE.currentUser.id);

            // Clicks Over Time Chart
            const clicksCtx = document.getElementById('clicksChart');
            if (clicksCtx) {
                const last7Days = Array.from({ length: 7 }, (_, i) => {
                    const d = new Date();
                    d.setDate(d.getDate() - (6 - i));
                    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                });

                new Chart(clicksCtx, {
                    type: 'line',
                    data: {
                        labels: last7Days,
                        datasets: [{
                            label: 'Clicks',
                            data: Array(7).fill(0).map((_, i) => Math.floor(Math.random() * 50)),
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            }

            // Device Chart
            const deviceCtx = document.getElementById('deviceChart');
            if (deviceCtx) {
                const allAnalytics = userLinks.flatMap(l => l.analytics || []);
                const devices = allAnalytics.reduce((acc, a) => {
                    acc[a.device] = (acc[a.device] || 0) + 1;
                    return acc;
                }, {});

                new Chart(deviceCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(devices).length > 0 ? Object.keys(devices) : ['Desktop', 'Mobile', 'Tablet'],
                        datasets: [{
                            data: Object.keys(devices).length > 0 ? Object.values(devices) : [45, 35, 20],
                            backgroundColor: ['#667eea', '#764ba2', '#f093fb']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true
                    }
                });
            }
        }

        // ==================== SETTINGS ====================
        async function fetchUserDomains() {
            if (!APP_STATE.currentUser) return;
            try {
                const response = await fetch('/api/domains', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        APP_STATE.domains = data.domains;
                    }
                }
            } catch (error) {
                console.error('Error fetching domains:', error);
            }
        }

        async function addDomain() {
            const domain = document.getElementById('newDomainInput').value;
            if (!domain) return showToast('Please enter a domain', 'error');

            try {
                const response = await fetch('/api/domains', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ domain })
                });
                const data = await response.json();
                if (response.ok && data.success) {
                    showToast('Domain added! Please verify it.', 'success');
                    document.getElementById('newDomainInput').value = '';
                    await fetchUserDomains();
                    render();
                } else {
                    showToast(data.error || 'Failed to add domain', 'error');
                }
            } catch (error) {
                showToast('Network error', 'error');
            }
        }

        async function verifyDomain(domainId) {
            try {
                const response = await fetch('/api/domains?action=verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ domainId })
                });
                const data = await response.json();
                if (response.ok && data.success) {
                    if (data.verified) {
                        showToast('Domain verified successfully!', 'success');
                    } else {
                        showToast('Verification failed. Check DNS records.', 'error');
                    }
                    await fetchUserDomains();
                    render();
                } else {
                    showToast(data.error || 'Verification failed', 'error');
                }
            } catch (error) {
                showToast('Network error', 'error');
            }
        }

        function renderSettings() {
            return `
                <div class="max-w-4xl mx-auto fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">
                            <i class="fas fa-cog gradient-bg bg-clip-text text-transparent"></i> Settings
                        </h2>
                        <button onclick="switchToDashboard()" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90 transition">
                            <i class="fas fa-arrow-left mr-2"></i> Back
                        </button>
                    </div>

                    <!-- Custom Domains -->
                    <div class="bg-white rounded-xl shadow-lg p-8 mb-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-globe"></i> Custom Domains
                        </h3>
                        
                        <div class="flex gap-4 mb-6">
                            <input type="text" id="newDomainInput" placeholder="example.com" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            <button onclick="addDomain()" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition font-bold">
                                Add Domain
                            </button>
                        </div>

                        <div class="space-y-4">
                            ${APP_STATE.domains && APP_STATE.domains.length > 0 ? APP_STATE.domains.map(d => `
                                <div class="border border-gray-200 rounded-xl p-4 flex flex-col md:flex-row justify-between items-center gap-4 bg-gray-50">
                                    <div>
                                        <p class="font-bold text-lg text-gray-800">${d.domain}</p>
                                        <div class="flex items-center space-x-2 mt-1">
                                            ${d.verified
                    ? '<span class="text-green-600 text-sm"><i class="fas fa-check-circle"></i> Verified</span>'
                    : '<span class="text-amber-600 text-sm"><i class="fas fa-exclamation-circle"></i> Unverified</span>'}
                                            <span class="text-xs text-gray-400">Added ${new Date(d.createdAt).toLocaleDateString()}</span>
                                        </div>
                                        ${!d.verified ? `
                                            <div class="mt-2 bg-amber-50 p-3 rounded border border-amber-100 text-sm text-amber-800">
                                                <p class="font-semibold mb-1">Verification Required:</p>
                                                <p>Add TXT record: <code class="bg-white px-2 py-0.5 rounded border border-amber-200 select-all">${d.txtRecord}</code></p>
                                            </div>
                                        ` : ''}
                                    </div>
                                    ${!d.verified ? `
                                        <button onclick="verifyDomain('${d.id}')" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition font-semibold w-full md:w-auto">
                                            Verify DNS
                                        </button>
                                    ` : `
                                        <div class="text-green-500 font-bold bg-green-50 px-4 py-2 rounded-lg border border-green-100">
                                            <i class="fas fa-check"></i> Active
                                        </div>
                                    `}
                                </div>
                            `).join('') : '<p class="text-gray-500 text-center py-4">No custom domains added yet.</p>'}
                        </div>
                    </div>

                    <!-- Branding Settings -->
                    <div class="bg-white rounded-xl shadow-lg p-8 mb-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-palette"></i> Branding
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Brand Name</label>
                                <input type="text" id="brandName" value="${APP_STATE.settings.brandName}" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Brand Color</label>
                                <input type="color" id="brandColor" value="${APP_STATE.settings.brandColor}" class="w-full h-12 border border-gray-300 rounded-lg cursor-pointer">
                            </div>
                        </div>
                    </div>

                    <!-- Account Settings -->
                    <div class="bg-white rounded-xl shadow-lg p-8 mb-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-user-cog"></i> Account Information
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Name</label>
                                <input type="text" value="${APP_STATE.currentUser.name}" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50" readonly>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Email</label>
                                <input type="email" value="${APP_STATE.currentUser.email}" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50" readonly>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Member Since</label>
                                <input type="text" value="${new Date(APP_STATE.currentUser.createdAt).toLocaleDateString()}" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- API Information -->
                    <div class="bg-white rounded-xl shadow-lg p-8">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-code"></i> API Access
                        </h3>
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <p class="text-sm text-gray-600 mb-2">Your API Token:</p>
                            <code class="block bg-gray-800 text-green-400 p-3 rounded font-mono text-sm break-all">${APP_STATE.currentUser.token}</code>
                            <button onclick="copyToClipboard('${APP_STATE.currentUser.token}')" class="mt-3 bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 transition">
                                <i class="fas fa-copy mr-2"></i> Copy Token
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-3">
                            <i class="fas fa-info-circle"></i> Use this token for API integration to programmatically shorten links.
                        </p>
                    </div>

                    <button onclick="saveSettings()" class="mt-6 gradient-bg text-white px-8 py-3 rounded-lg font-semibold hover:opacity-90 transition">
                        <i class="fas fa-save mr-2"></i> Save Settings
                    </button>
                </div>
            `;
        }

        function saveSettings() {
            const brandName = document.getElementById('brandName').value;
            const brandColor = document.getElementById('brandColor').value;

            APP_STATE.settings.brandName = brandName;
            APP_STATE.settings.brandColor = brandColor;

            saveToLocalStorage();
            // document.getElementById('brandName').textContent = brandName; // There is no ID 'brandName' in nav? Ah, user might have meant the nav brand.

            showToast('Settings saved successfully!', 'success');
        }

        // ==================== NAVIGATION ====================
        function updateNavigation() {
            const navButtons = document.getElementById('navButtons');
            const mobileNavButtons = document.getElementById('mobileNavButtons');

            if (APP_STATE.currentUser) {
                navButtons.innerHTML = `
                    <button onclick="switchToDashboard()" class="text-white hover:text-purple-200 transition">
                        <i class="fas fa-th-large mr-1"></i> Dashboard
                    </button>
                    <button onclick="switchToLinks()" class="text-white hover:text-purple-200 transition">
                        <i class="fas fa-list mr-1"></i> Link List
                    </button>
                    <button onclick="switchToAnalytics()" class="text-white hover:text-purple-200 transition">
                        <i class="fas fa-chart-bar mr-1"></i> Analytics
                    </button>
                    <button onclick="switchToSettings()" class="text-white hover:text-purple-200 transition">
                        <i class="fas fa-cog mr-1"></i> Settings
                    </button>
                    <button onclick="handleLogout()" class="bg-white text-purple-600 px-4 py-2 rounded-lg hover:bg-purple-100 transition">
                        <i class="fas fa-sign-out-alt mr-1"></i> Logout
                    </button>
                `;

                mobileNavButtons.innerHTML = `
                    <button onclick="switchToDashboard(); closeMobileMenu()" class="w-full text-left text-gray-700 hover:bg-purple-50 px-4 py-3 rounded-lg transition">
                        <i class="fas fa-th-large mr-2"></i> Dashboard
                    </button>
                    <button onclick="switchToLinks(); closeMobileMenu()" class="w-full text-left text-gray-700 hover:bg-purple-50 px-4 py-3 rounded-lg transition">
                        <i class="fas fa-list mr-2"></i> Link List
                    </button>
                    <button onclick="switchToAnalytics(); closeMobileMenu()" class="w-full text-left text-gray-700 hover:bg-purple-50 px-4 py-3 rounded-lg transition">
                        <i class="fas fa-chart-bar mr-2"></i> Analytics
                    </button>
                    <button onclick="switchToSettings(); closeMobileMenu()" class="w-full text-left text-gray-700 hover:bg-purple-50 px-4 py-3 rounded-lg transition">
                        <i class="fas fa-cog mr-2"></i> Settings
                    </button>
                    <button onclick="handleLogout(); closeMobileMenu()" class="w-full text-left text-red-600 hover:bg-red-50 px-4 py-3 rounded-lg transition">
                        <i class="fas fa-sign-out-alt mr-2"></i> Logout
                    </button>
                `;
            } else {
                navButtons.innerHTML = `
                    <button onclick="switchToLogin()" class="text-white hover:text-purple-200 transition font-semibold">
                        Sign In
                    </button>
                    <button onclick="switchToSignup()" class="bg-white text-purple-600 px-5 py-2 rounded-full hover:bg-purple-100 transition font-bold shadow-md">
                        Get Started
                    </button>
                `;
                mobileNavButtons.innerHTML = `
                     <button onclick="switchToLogin(); closeMobileMenu()" class="w-full text-left text-gray-700 hover:bg-purple-50 px-4 py-3 rounded-lg transition font-semibold">
                        Sign In
                    </button>
                    <button onclick="switchToSignup(); closeMobileMenu()" class="w-full text-left text-purple-600 hover:bg-purple-50 px-4 py-3 rounded-lg transition font-bold">
                        Create Account
                    </button>
                `;
            }

            // Add mobile menu event listeners
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
            const closeMobileMenuBtn = document.getElementById('closeMobileMenu');

            if (mobileMenuBtn) {
                mobileMenuBtn.addEventListener('click', toggleMobileMenu);
            }

            if (closeMobileMenuBtn) {
                closeMobileMenuBtn.addEventListener('click', closeMobileMenu);
            }

            if (mobileMenuOverlay) {
                mobileMenuOverlay.addEventListener('click', function (e) {
                    if (e.target === mobileMenuOverlay) {
                        closeMobileMenu();
                    }
                });
            }
        }

        function toggleMobileMenu() {
            const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
            const mobileMenuContent = document.querySelector('.mobile-menu-content');

            if (mobileMenuOverlay.classList.contains('active')) {
                closeMobileMenu();
            } else {
                mobileMenuOverlay.classList.add('active');
                mobileMenuContent.classList.add('active');
            }
        }

        function closeMobileMenu() {
            const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
            const mobileMenuContent = document.querySelector('.mobile-menu-content');

            mobileMenuOverlay.classList.remove('active');
            mobileMenuContent.classList.remove('active');
        }

        function switchToLogin() {
            APP_STATE.currentView = 'login';
            render();
        }

        function switchToSignup() {
            APP_STATE.currentView = 'signup';
            render();
        }

        async function switchToDashboard() {
            APP_STATE.currentView = 'dashboard';
            // Always fetch fresh links and domains
            await Promise.all([
                fetchUserLinks(),
                fetchUserDomains()
            ]);
            render();
        }

        function switchToLinks() {
            window.location.href = '/links.html';
        }

        function switchToAnalytics() {
            APP_STATE.currentView = 'analytics';
            render();
        }

        function switchToSettings() {
            APP_STATE.currentView = 'settings';
            fetchUserDomains(); // Fetch in case we go directly to settings? Backup.
            render();
        }


        // ==================== MAIN RENDER ====================
        function render() {
            const app = document.getElementById('app');

            if (!APP_STATE.currentUser) {
                if (APP_STATE.currentView === 'signup') {
                    app.innerHTML = renderSignup();
                } else if (APP_STATE.currentView === 'login') {
                    app.innerHTML = renderLogin();
                } else {
                    // Default to Home for guests
                    app.innerHTML = renderHome();
                }
            } else {
                switch (APP_STATE.currentView) {
                    case 'analytics':
                        app.innerHTML = renderAnalytics();
                        setTimeout(initializeCharts, 100);
                        break;
                    case 'settings':
                        app.innerHTML = renderSettings();
                        break;
                    default:
                        app.innerHTML = renderDashboard();
                }
            }

            updateNavigation();

            // Add event listener for custom expiry selection
            const expirySelect = document.getElementById('expiryTime');
            if (expirySelect) {
                expirySelect.addEventListener('change', function () {
                    const customContainer = document.getElementById('customExpiryContainer');
                    if (this.value === 'custom') {
                        customContainer.classList.remove('hidden');
                    } else {
                        customContainer.classList.add('hidden');
                    }
                });
            }
        }

        // ==================== INITIALIZATION ====================
        window.addEventListener('DOMContentLoaded', async () => {
            // Auto-login if token exists
            const authToken = localStorage.getItem('authToken');

            if (authToken) {
                try {
                    // First, get user data from /api/auth/me
                    const userResponse = await fetch('/api/auth?type=me', {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });

                    if (userResponse.ok) {
                        const userData = await userResponse.json();
                        if (userData.success) {
                            APP_STATE.currentUser = userData.user;

                            // Then fetch user's links
                            const linksResponse = await fetch('/api/links', {
                                headers: {
                                    'Authorization': `Bearer ${authToken}`
                                }
                            });

                            if (linksResponse.ok) {
                                const linksData = await linksResponse.json();
                                if (linksData.success) {
                                    APP_STATE.links = linksData.links;

                                    // Handle Deep Linking via Query Params
                                    const urlParams = new URLSearchParams(window.location.search);
                                    const viewParam = urlParams.get('view');
                                    const validViews = ['dashboard', 'analytics', 'settings', 'links'];

                                    if (viewParam && validViews.includes(viewParam)) {
                                        if (viewParam === 'links') {
                                            window.location.href = '/links.html';
                                            return;
                                        }
                                        APP_STATE.currentView = viewParam;
                                        // If specific view needs data (like settings -> domains), fetch it
                                        if (viewParam === 'settings') fetchUserDomains();
                                        if (viewParam === 'analytics') setTimeout(initializeCharts, 100);
                                    } else {
                                        APP_STATE.currentView = 'dashboard';
                                    }
                                }
                            }
                        }
                    } else {
                        // Token is invalid, clear it
                        localStorage.removeItem('authToken');
                    }
                } catch (error) {
                    console.error('Auto-login failed:', error);
                    // Clear invalid token
                    localStorage.removeItem('authToken');
                }
            }

            render();
        });
    </script>
</body>

</html>