<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureLink - Modern Link Shortener</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        .fade-in { animation: fadeIn 0.6s ease-out; }
        .slide-in { animation: slideIn 0.4s ease-out; }
        .pulse-animation { animation: pulse 2s infinite; }
        .float-animation { animation: float 3s ease-in-out infinite; }
        
        .gradient-bg { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 200% 200%;
            animation: gradient 15s ease infinite;
        }
        
        .glass-effect { 
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
        }
        
        .custom-scrollbar::-webkit-scrollbar { width: 10px; }
        .custom-scrollbar::-webkit-scrollbar-track { 
            background: #f1f1f1; 
            border-radius: 10px; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #764ba2; }
        
        .captcha-box {
            border: 2px dashed #667eea;
            padding: 20px;
            border-radius: 12px;
            background: linear-gradient(135deg, #f9fafb 0%, #e0e7ff 100%);
        }
        
        .link-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 4px solid transparent;
        }
        
        .link-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px -5px rgba(102, 126, 234, 0.3);
            border-left-color: #667eea;
        }
        
        .shimmer {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }
        
        .stat-card {
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            transform: rotate(45deg);
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        
        .btn-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        
        .neon-text {
            text-shadow: 0 0 10px rgba(102, 126, 234, 0.8),
                         0 0 20px rgba(102, 126, 234, 0.6),
                         0 0 30px rgba(102, 126, 234, 0.4);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="gradient-bg text-white shadow-lg" id="navbar">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-link text-2xl"></i>
                    <span class="text-2xl font-bold" id="brandName">SecureLink</span>
                </div>
                <div id="navButtons" class="flex space-x-4"></div>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div id="app" class="container mx-auto px-4 py-8"></div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <script>
        // ==================== GLOBAL STATE ====================
        const APP_STATE = {
            currentUser: null,
            currentView: 'login',
            links: [],
            settings: JSON.parse(localStorage.getItem('settings')) || {
                brandName: 'SecureLink',
                brandColor: '#667eea',
                logo: null
            },
            captchaVerified: false
        };

        // ==================== API FUNCTIONS ====================
        async function fetchUserLinks() {
            if (!APP_STATE.currentUser) return;

            try {
                const response = await fetch('/api/links', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        APP_STATE.links = data.links;
                    }
                }
            } catch (error) {
                console.error('Error fetching user links:', error);
            }
        }

        // ==================== UTILITY FUNCTIONS ====================
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `px-6 py-4 rounded-lg shadow-lg text-white transform transition-all duration-300 ${
                type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            }`;
            toast.innerHTML = `
                <div class="flex items-center space-x-2">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function generateShortCode(length = 6) {
            const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function isValidURL(url) {
            try {
                const urlPattern = /^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?$/;
                return urlPattern.test(url);
            } catch (e) {
                return false;
            }
        }

        function isMaliciousURL(url) {
            const maliciousPatterns = ['malware', 'phishing', 'spam', 'scam', 'hack'];
            const lowerUrl = url.toLowerCase();
            return maliciousPatterns.some(pattern => lowerUrl.includes(pattern));
        }

        function saveToLocalStorage() {
            localStorage.setItem('links', JSON.stringify(APP_STATE.links));
            localStorage.setItem('users', JSON.stringify(APP_STATE.users));
            localStorage.setItem('settings', JSON.stringify(APP_STATE.settings));
        }

        function generateToken() {
            return 'token_' + Math.random().toString(36).substr(2) + Date.now().toString(36);
        }

        function checkLinkExpiry(link) {
            if (!link.expiryTime) return false;
            return new Date() > new Date(link.expiryTime);
        }

        function getDeviceType() {
            const ua = navigator.userAgent;
            if (/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(ua)) {
                return 'Tablet';
            }
            if (/Mobile|Android|iP(hone|od)|IEMobile|BlackBerry|Kindle|Silk-Accelerated|(hpw|web)OS|Opera M(obi|ini)/.test(ua)) {
                return 'Mobile';
            }
            return 'Desktop';
        }

        function generateCaptcha() {
            const num1 = Math.floor(Math.random() * 10);
            const num2 = Math.floor(Math.random() * 10);
            return { num1, num2, answer: num1 + num2 };
        }

        // ==================== AUTHENTICATION ====================
        function renderLogin() {
            const captcha = generateCaptcha();
            APP_STATE.currentCaptcha = captcha;
            APP_STATE.captchaVerified = false;

            return `
                <div class="max-w-md mx-auto mt-16 fade-in">
                    <div class="bg-white rounded-2xl shadow-xl p-8">
                        <div class="text-center mb-8">
                            <i class="fas fa-lock text-6xl gradient-bg bg-clip-text text-transparent mb-4"></i>
                            <h2 class="text-3xl font-bold text-gray-800">Welcome Back</h2>
                            <p class="text-gray-600 mt-2">Sign in to manage your links</p>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Email</label>
                                <input type="email" id="loginEmail" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Enter your email">
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Password</label>
                                <input type="password" id="loginPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Enter your password">
                            </div>

                            <!-- CAPTCHA -->
                            <div class="captcha-box">
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-shield-alt"></i> Security Check
                                </label>
                                <div class="flex items-center space-x-4">
                                    <div class="text-xl font-bold gradient-bg text-white px-4 py-2 rounded">
                                        ${captcha.num1} + ${captcha.num2} = ?
                                    </div>
                                    <input type="number" id="captchaAnswer" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Answer">
                                </div>
                            </div>
                            
                            <button onclick="handleLogin()" class="w-full gradient-bg text-white py-3 rounded-lg font-semibold hover:opacity-90 transition duration-300">
                                <i class="fas fa-sign-in-alt mr-2"></i> Sign In
                            </button>
                            
                            <div class="text-center">
                                <button onclick="switchToSignup()" class="text-purple-600 hover:underline">
                                    Don't have an account? Sign up
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSignup() {
            const captcha = generateCaptcha();
            APP_STATE.currentCaptcha = captcha;
            APP_STATE.captchaVerified = false;

            return `
                <div class="max-w-md mx-auto mt-16 fade-in">
                    <div class="bg-white rounded-2xl shadow-xl p-8">
                        <div class="text-center mb-8">
                            <i class="fas fa-user-plus text-6xl gradient-bg bg-clip-text text-transparent mb-4"></i>
                            <h2 class="text-3xl font-bold text-gray-800">Create Account</h2>
                            <p class="text-gray-600 mt-2">Join SecureLink today</p>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Full Name</label>
                                <input type="text" id="signupName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Enter your name">
                            </div>

                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Email</label>
                                <input type="email" id="signupEmail" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Enter your email">
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Password</label>
                                <input type="password" id="signupPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Create a password">
                            </div>

                            <!-- CAPTCHA -->
                            <div class="captcha-box">
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-shield-alt"></i> Security Check
                                </label>
                                <div class="flex items-center space-x-4">
                                    <div class="text-xl font-bold gradient-bg text-white px-4 py-2 rounded">
                                        ${captcha.num1} + ${captcha.num2} = ?
                                    </div>
                                    <input type="number" id="captchaAnswer" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Answer">
                                </div>
                            </div>
                            
                            <button onclick="handleSignup()" class="w-full gradient-bg text-white py-3 rounded-lg font-semibold hover:opacity-90 transition duration-300">
                                <i class="fas fa-user-check mr-2"></i> Create Account
                            </button>
                            
                            <div class="text-center">
                                <button onclick="switchToLogin()" class="text-purple-600 hover:underline">
                                    Already have an account? Sign in
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const captchaAnswer = parseInt(document.getElementById('captchaAnswer').value);

            if (!email || !password) {
                showToast('Please fill in all fields', 'error');
                return;
            }

            if (captchaAnswer !== APP_STATE.currentCaptcha.answer) {
                showToast('CAPTCHA verification failed', 'error');
                return;
            }

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email,
                        password,
                        captchaAnswer,
                        captchaCorrect: APP_STATE.currentCaptcha.answer
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    APP_STATE.currentUser = data.user;
                    localStorage.setItem('authToken', data.user.token);
                    showToast('Login successful!', 'success');
                    await fetchUserLinks();
                    switchToDashboard();
                } else {
                    showToast(data.error || 'Login failed', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showToast('Network error. Please try again.', 'error');
            }
        }

        async function handleSignup() {
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const captchaAnswer = parseInt(document.getElementById('captchaAnswer').value);

            if (!name || !email || !password) {
                showToast('Please fill in all fields', 'error');
                return;
            }

            if (captchaAnswer !== APP_STATE.currentCaptcha.answer) {
                showToast('CAPTCHA verification failed', 'error');
                return;
            }

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name,
                        email,
                        password,
                        captchaAnswer,
                        captchaCorrect: APP_STATE.currentCaptcha.answer
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    APP_STATE.currentUser = data.user;
                    localStorage.setItem('authToken', data.user.token);
                    showToast('Account created successfully!', 'success');
                    switchToDashboard();
                } else {
                    showToast(data.error || 'Registration failed', 'error');
                }
            } catch (error) {
                console.error('Signup error:', error);
                showToast('Network error. Please try again.', 'error');
            }
        }

        function handleLogout() {
            APP_STATE.currentUser = null;
            showToast('Logged out successfully', 'info');
            switchToLogin();
        }

        // ==================== DASHBOARD ====================
        function renderDashboard() {
            const userLinks = APP_STATE.links.filter(l => l.userId === APP_STATE.currentUser.id);
            const activeLinks = userLinks.filter(l => !checkLinkExpiry(l));
            const totalClicks = userLinks.reduce((sum, l) => sum + (l.clicks || 0), 0);
            const expiredLinks = userLinks.filter(l => checkLinkExpiry(l));

            return `
                <div class="fade-in">
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white rounded-xl shadow-lg p-6 link-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-600 text-sm font-semibold">Total Links</p>
                                    <p class="text-3xl font-bold text-gray-800 mt-2">${userLinks.length}</p>
                                </div>
                                <div class="bg-blue-100 p-4 rounded-full">
                                    <i class="fas fa-link text-blue-600 text-2xl"></i>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-lg p-6 link-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-600 text-sm font-semibold">Active Links</p>
                                    <p class="text-3xl font-bold text-green-600 mt-2">${activeLinks.length}</p>
                                </div>
                                <div class="bg-green-100 p-4 rounded-full">
                                    <i class="fas fa-check-circle text-green-600 text-2xl"></i>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-lg p-6 link-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-600 text-sm font-semibold">Total Clicks</p>
                                    <p class="text-3xl font-bold text-purple-600 mt-2">${totalClicks}</p>
                                </div>
                                <div class="bg-purple-100 p-4 rounded-full">
                                    <i class="fas fa-mouse-pointer text-purple-600 text-2xl"></i>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-lg p-6 link-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-600 text-sm font-semibold">Expired Links</p>
                                    <p class="text-3xl font-bold text-red-600 mt-2">${expiredLinks.length}</p>
                                </div>
                                <div class="bg-red-100 p-4 rounded-full">
                                    <i class="fas fa-clock text-red-600 text-2xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Create New Link -->
                    <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
                        <h3 class="text-2xl font-bold text-gray-800 mb-6">
                            <i class="fas fa-plus-circle gradient-bg bg-clip-text text-transparent"></i> Create New Link
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="md:col-span-2">
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-globe"></i> Original URL
                                </label>
                                <input type="url" id="originalUrl" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="https://example.com/very-long-url">
                            </div>

                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-tag"></i> Custom Alias (Optional)
                                </label>
                                <input type="text" id="customAlias" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="my-custom-link">
                            </div>

                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-clock"></i> Expiry Time
                                </label>
                                <select id="expiryTime" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                    <option value="">No Expiry</option>
                                    <option value="5">5 Minutes</option>
                                    <option value="10">10 Minutes</option>
                                    <option value="30">30 Minutes</option>
                                    <option value="60">1 Hour</option>
                                    <option value="1440">24 Hours</option>
                                    <option value="10080">7 Days</option>
                                    <option value="custom">Custom Date/Time</option>
                                </select>
                            </div>

                            <div id="customExpiryContainer" class="hidden md:col-span-2">
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-calendar-alt"></i> Custom Expiry Date & Time
                                </label>
                                <input type="datetime-local" id="customExpiryDate" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>

                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-lock"></i> Password Protection (Optional)
                                </label>
                                <input type="password" id="linkPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Set a password">
                            </div>

                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-image"></i> Link Title (Optional)
                                </label>
                                <input type="text" id="linkTitle" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="My Link">
                            </div>
                        </div>

                        <button onclick="createLink()" class="mt-6 gradient-bg text-white px-8 py-3 rounded-lg font-semibold hover:opacity-90 transition duration-300 pulse-animation">
                            <i class="fas fa-magic mr-2"></i> Generate Short Link
                        </button>
                    </div>

                    <!-- Links List -->
                    <div class="bg-white rounded-xl shadow-lg p-8">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-2xl font-bold text-gray-800">
                                <i class="fas fa-list"></i> Your Links
                            </h3>
                            <div class="flex space-x-3">
                                <button id="deleteSelectedBtn" onclick="deleteSelectedLinks()" class="hidden bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 transition font-semibold">
                                    <i class="fas fa-trash-alt mr-2"></i> Delete Selected (<span id="selectedCount">0</span>)
                                </button>
                                <button onclick="switchToAnalytics()" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90 transition">
                                    <i class="fas fa-chart-bar mr-2"></i> View Analytics
                                </button>
                            </div>
                        </div>
                        
                        <div class="space-y-4 custom-scrollbar max-h-96 overflow-y-auto" id="linksList">
                            ${renderLinksList(userLinks)}
                        </div>
                    </div>
                </div>
            `;
        }

        // Selected links state
        let selectedLinkIds = new Set();

        function renderLinksList(links) {
            if (links.length === 0) {
                return `
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-inbox text-6xl mb-4"></i>
                        <p class="text-xl">No links created yet</p>
                    </div>
                `;
            }

            const selectAllChecked = selectedLinkIds.size === links.length && links.length > 0;
            
            return `
                <!-- Select All Checkbox -->
                <div class="flex items-center justify-between p-4 bg-purple-50 rounded-lg mb-4 border-2 border-purple-200">
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input 
                            type="checkbox" 
                            id="selectAll" 
                            ${selectAllChecked ? 'checked' : ''} 
                            onchange="toggleSelectAll(this.checked)"
                            class="w-5 h-5 text-purple-600 rounded focus:ring-2 focus:ring-purple-500 cursor-pointer"
                        >
                        <span class="font-semibold text-purple-800">
                            <i class="fas fa-check-double mr-2"></i>Select All Links
                        </span>
                    </label>
                    <span class="text-sm text-purple-700 font-medium">
                        ${selectedLinkIds.size} of ${links.length} selected
                    </span>
                </div>

                <!-- Links -->
                ${links.map(link => {
                    const isExpired = checkLinkExpiry(link);
                    const shortUrl = `${window.location.origin}/${link.shortCode}`;
                    const isSelected = selectedLinkIds.has(link.id);
                    
                    return `
                        <div class="border-2 ${isSelected ? 'border-purple-500 bg-purple-50' : 'border-gray-200 bg-gray-50'} rounded-lg p-4 link-card ${isExpired ? 'opacity-60' : ''} transition-all duration-200">
                            <div class="flex items-start space-x-3">
                                <!-- Checkbox -->
                                <input 
                                    type="checkbox" 
                                    ${isSelected ? 'checked' : ''} 
                                    onchange="toggleLinkSelection('${link.id}', this.checked)"
                                    class="w-5 h-5 mt-1 text-purple-600 rounded focus:ring-2 focus:ring-purple-500 cursor-pointer"
                                >
                                
                                <!-- Link Content -->
                                <div class="flex-1">
                                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center space-y-3 md:space-y-0">
                                        <div class="flex-1">
                                            <div class="flex items-center space-x-2 mb-2">
                                                ${link.title ? `<h4 class="font-semibold text-gray-800">${link.title}</h4>` : ''}
                                                ${isExpired ? '<span class="bg-red-500 text-white px-2 py-1 rounded text-xs">Expired</span>' : '<span class="bg-green-500 text-white px-2 py-1 rounded text-xs">Active</span>'}
                                                ${link.password ? '<i class="fas fa-lock text-yellow-600" title="Password Protected"></i>' : ''}
                                            </div>
                                            <p class="text-sm text-gray-600 mb-1 break-all">
                                                <i class="fas fa-link text-purple-600"></i> <strong>Short:</strong> 
                                                <a href="#" onclick="openLink('${link.shortCode}')" class="text-purple-600 hover:underline">${shortUrl}</a>
                                            </p>
                                            <p class="text-xs text-gray-500 break-all">
                                                <i class="fas fa-external-link-alt"></i> <strong>Original:</strong> ${link.originalUrl}
                                            </p>
                                            <div class="flex items-center space-x-4 mt-2 text-xs text-gray-600">
                                                <span><i class="fas fa-mouse-pointer"></i> ${link.clicks || 0} clicks</span>
                                                ${link.expiryTime ? `<span><i class="fas fa-clock"></i> Expires: ${new Date(link.expiryTime).toLocaleString()}</span>` : ''}
                                            </div>
                                        </div>
                                        
                                        <div class="flex items-center space-x-2">
                                            <button onclick="copyToClipboard('${shortUrl}')" class="bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600 transition" title="Copy">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                            <button onclick="showQRCode('${link.shortCode}')" class="bg-purple-500 text-white px-3 py-2 rounded hover:bg-purple-600 transition" title="QR Code">
                                                <i class="fas fa-qrcode"></i>
                                            </button>
                                            <button onclick="viewLinkAnalytics('${link.id}')" class="bg-green-500 text-white px-3 py-2 rounded hover:bg-green-600 transition" title="Analytics">
                                                <i class="fas fa-chart-line"></i>
                                            </button>
                                            <button onclick="deleteLink('${link.id}')" class="bg-red-500 text-white px-3 py-2 rounded hover:bg-red-600 transition" title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }

        function toggleLinkSelection(linkId, isChecked) {
            if (isChecked) {
                selectedLinkIds.add(linkId);
            } else {
                selectedLinkIds.delete(linkId);
            }
            updateDeleteButton();
        }

        function toggleSelectAll(isChecked) {
            const userLinks = APP_STATE.links.filter(l => l.userId === APP_STATE.currentUser.id);
            
            if (isChecked) {
                userLinks.forEach(link => selectedLinkIds.add(link.id));
            } else {
                selectedLinkIds.clear();
            }
            
            render();
        }

        function updateDeleteButton() {
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            const countSpan = document.getElementById('selectedCount');
            
            if (deleteBtn && countSpan) {
                countSpan.textContent = selectedLinkIds.size;
                
                if (selectedLinkIds.size > 0) {
                    deleteBtn.classList.remove('hidden');
                } else {
                    deleteBtn.classList.add('hidden');
                }
            }
        }

        function deleteSelectedLinks() {
            if (selectedLinkIds.size === 0) {
                showToast('No links selected', 'error');
                return;
            }

            const count = selectedLinkIds.size;
            const confirmed = confirm(`Are you sure you want to delete ${count} selected link${count > 1 ? 's' : ''}? This action cannot be undone.`);
            
            if (confirmed) {
                APP_STATE.links = APP_STATE.links.filter(link => !selectedLinkIds.has(link.id));
                saveToLocalStorage();
                selectedLinkIds.clear();
                showToast(`Successfully deleted ${count} link${count > 1 ? 's' : ''}!`, 'success');
                render();
            }
        }

        async function createLink() {
            const originalUrl = document.getElementById('originalUrl').value;
            const customAlias = document.getElementById('customAlias').value;
            const expiryTime = document.getElementById('expiryTime').value;
            const linkPassword = document.getElementById('linkPassword').value;
            const linkTitle = document.getElementById('linkTitle').value;

            if (!originalUrl) {
                showToast('Please enter a URL', 'error');
                return;
            }

            if (!isValidURL(originalUrl)) {
                showToast('Please enter a valid URL', 'error');
                return;
            }

            if (isMaliciousURL(originalUrl)) {
                showToast('This URL has been flagged as potentially malicious and cannot be shortened', 'error');
                return;
            }

            let expiryDateTime = null;
            if (expiryTime === 'custom') {
                const customDate = document.getElementById('customExpiryDate').value;
                if (!customDate) {
                    showToast('Please select a custom expiry date', 'error');
                    return;
                }
                expiryDateTime = new Date(customDate).toISOString();
            } else if (expiryTime) {
                expiryDateTime = new Date(Date.now() + parseInt(expiryTime) * 60000).toISOString();
            }

            try {
                const response = await fetch('/api/links/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        originalUrl,
                        customAlias,
                        title: linkTitle,
                        password: linkPassword,
                        expiryTime: expiryDateTime
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showToast('Link created successfully!', 'success');

                    // Clear form
                    document.getElementById('originalUrl').value = '';
                    document.getElementById('customAlias').value = '';
                    document.getElementById('expiryTime').value = '';
                    document.getElementById('linkPassword').value = '';
                    document.getElementById('linkTitle').value = '';

                    // Refresh links from API
                    await fetchUserLinks();
                    render();
                } else {
                    showToast(data.error || 'Failed to create link', 'error');
                }
            } catch (error) {
                console.error('Create link error:', error);
                showToast('Network error. Please try again.', 'error');
            }
        }

        async function deleteLink(linkId) {
            if (confirm('Are you sure you want to delete this link?')) {
                try {
                    const response = await fetch(`/api/links/${linkId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        }
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        APP_STATE.links = APP_STATE.links.filter(l => l.id !== linkId);
                        showToast('Link deleted', 'info');
                        render();
                    } else {
                        showToast(data.error || 'Failed to delete link', 'error');
                    }
                } catch (error) {
                    console.error('Delete link error:', error);
                    showToast('Network error. Please try again.', 'error');
                }
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied to clipboard!', 'success');
            });
        }

        function showQRCode(shortCode) {
            const link = APP_STATE.links.find(l => l.shortCode === shortCode);
            const shortUrl = `${window.location.origin}/${shortCode}`;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 fade-in">
                    <div class="text-center">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">QR Code</h3>
                        <div id="qrcodeContainer" class="flex justify-center mb-4"></div>
                        <p class="text-sm text-gray-600 mb-2 break-all">${shortUrl}</p>
                        <button onclick="this.closest('.fixed').remove()" class="gradient-bg text-white px-6 py-2 rounded-lg hover:opacity-90 transition">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            new QRCode(document.getElementById('qrcodeContainer'), {
                text: shortUrl,
                width: 256,
                height: 256
            });
        }

        function openLink(shortCode) {
            const link = APP_STATE.links.find(l => l.shortCode === shortCode);
            
            if (!link) {
                showToast('Link not found', 'error');
                return;
            }

            if (checkLinkExpiry(link)) {
                showToast('This link has expired', 'error');
                return;
            }

            if (link.password) {
                const password = prompt('This link is password protected. Please enter the password:');
                if (password !== link.password) {
                    showToast('Incorrect password', 'error');
                    return;
                }
            }

            // Record analytics
            const analyticsData = {
                timestamp: new Date().toISOString(),
                device: getDeviceType(),
                referrer: document.referrer || 'Direct',
                userAgent: navigator.userAgent
            };

            link.clicks = (link.clicks || 0) + 1;
            if (!link.analytics) link.analytics = [];
            link.analytics.push(analyticsData);
            
            saveToLocalStorage();
            
            window.open(link.originalUrl, '_blank');
            showToast('Redirecting...', 'info');
        }

        // ==================== ANALYTICS ====================
        function renderAnalytics() {
            const userLinks = APP_STATE.links.filter(l => l.userId === APP_STATE.currentUser.id);
            
            return `
                <div class="fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">
                            <i class="fas fa-chart-bar gradient-bg bg-clip-text text-transparent"></i> Analytics Dashboard
                        </h2>
                        <button onclick="switchToDashboard()" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90 transition">
                            <i class="fas fa-arrow-left mr-2"></i> Back to Dashboard
                        </button>
                    </div>

                    <!-- Overall Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        ${renderOverallStats(userLinks)}
                    </div>

                    <!-- Charts -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Clicks Over Time</h3>
                            <canvas id="clicksChart"></canvas>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Device Distribution</h3>
                            <canvas id="deviceChart"></canvas>
                        </div>
                    </div>

                    <!-- Top Links -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Top Performing Links</h3>
                        ${renderTopLinks(userLinks)}
                    </div>
                </div>
            `;
        }

        function renderOverallStats(links) {
            const totalClicks = links.reduce((sum, l) => sum + (l.clicks || 0), 0);
            const avgCTR = links.length > 0 ? (totalClicks / links.length).toFixed(2) : 0;
            const mostClicked = links.reduce((max, l) => (l.clicks || 0) > (max.clicks || 0) ? l : max, {});

            return `
                <div class="bg-gradient-to-br from-purple-500 to-purple-700 rounded-xl shadow-lg p-6 text-white">
                    <i class="fas fa-mouse-pointer text-3xl mb-2"></i>
                    <p class="text-sm font-semibold opacity-90">Total Clicks</p>
                    <p class="text-4xl font-bold mt-2">${totalClicks}</p>
                </div>
                
                <div class="bg-gradient-to-br from-blue-500 to-blue-700 rounded-xl shadow-lg p-6 text-white">
                    <i class="fas fa-chart-line text-3xl mb-2"></i>
                    <p class="text-sm font-semibold opacity-90">Average CTR</p>
                    <p class="text-4xl font-bold mt-2">${avgCTR}</p>
                </div>
                
                <div class="bg-gradient-to-br from-green-500 to-green-700 rounded-xl shadow-lg p-6 text-white">
                    <i class="fas fa-star text-3xl mb-2"></i>
                    <p class="text-sm font-semibold opacity-90">Most Clicked</p>
                    <p class="text-2xl font-bold mt-2 truncate">${mostClicked.shortCode || 'N/A'}</p>
                    <p class="text-sm opacity-90">${mostClicked.clicks || 0} clicks</p>
                </div>
            `;
        }

        function renderTopLinks(links) {
            const sorted = links.sort((a, b) => (b.clicks || 0) - (a.clicks || 0)).slice(0, 5);
            
            if (sorted.length === 0) {
                return '<p class="text-gray-500 text-center py-8">No data available</p>';
            }

            return `
                <div class="space-y-3">
                    ${sorted.map((link, index) => `
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                            <div class="flex items-center space-x-4">
                                <div class="bg-purple-100 text-purple-700 w-8 h-8 rounded-full flex items-center justify-center font-bold">
                                    ${index + 1}
                                </div>
                                <div>
                                    <p class="font-semibold text-gray-800">${link.title || link.shortCode}</p>
                                    <p class="text-sm text-gray-500">${window.location.origin}/${link.shortCode}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-2xl font-bold text-purple-600">${link.clicks || 0}</p>
                                <p class="text-xs text-gray-500">clicks</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function viewLinkAnalytics(linkId) {
            const link = APP_STATE.links.find(l => l.id === linkId);
            if (!link) return;

            const analytics = link.analytics || [];
            const devices = analytics.reduce((acc, a) => {
                acc[a.device] = (acc[a.device] || 0) + 1;
                return acc;
            }, {});

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-8 max-w-4xl w-full mx-4 my-8 fade-in">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">
                        <i class="fas fa-chart-pie gradient-bg bg-clip-text text-transparent"></i> 
                        Link Analytics: ${link.title || link.shortCode}
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-purple-50 p-4 rounded-lg text-center">
                            <i class="fas fa-mouse-pointer text-purple-600 text-2xl mb-2"></i>
                            <p class="text-sm text-gray-600">Total Clicks</p>
                            <p class="text-3xl font-bold text-purple-700">${link.clicks || 0}</p>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg text-center">
                            <i class="fas fa-desktop text-blue-600 text-2xl mb-2"></i>
                            <p class="text-sm text-gray-600">Desktop</p>
                            <p class="text-3xl font-bold text-blue-700">${devices['Desktop'] || 0}</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg text-center">
                            <i class="fas fa-mobile-alt text-green-600 text-2xl mb-2"></i>
                            <p class="text-sm text-gray-600">Mobile</p>
                            <p class="text-3xl font-bold text-green-700">${devices['Mobile'] || 0}</p>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h4 class="font-semibold text-gray-800 mb-3">Recent Activity</h4>
                        <div class="max-h-64 overflow-y-auto custom-scrollbar">
                            ${analytics.length > 0 ? analytics.slice(-10).reverse().map(a => `
                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg mb-2">
                                    <div class="flex items-center space-x-3">
                                        <i class="fas fa-${a.device === 'Mobile' ? 'mobile-alt' : a.device === 'Tablet' ? 'tablet-alt' : 'desktop'} text-gray-600"></i>
                                        <div>
                                            <p class="text-sm font-semibold text-gray-800">${a.device}</p>
                                            <p class="text-xs text-gray-500">${new Date(a.timestamp).toLocaleString()}</p>
                                        </div>
                                    </div>
                                    <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">${a.referrer}</span>
                                </div>
                            `).join('') : '<p class="text-gray-500 text-center py-4">No analytics data yet</p>'}
                        </div>
                    </div>
                    
                    <button onclick="this.closest('.fixed').remove()" class="gradient-bg text-white px-6 py-2 rounded-lg hover:opacity-90 transition">
                        Close
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function initializeCharts() {
            const userLinks = APP_STATE.links.filter(l => l.userId === APP_STATE.currentUser.id);
            
            // Clicks Over Time Chart
            const clicksCtx = document.getElementById('clicksChart');
            if (clicksCtx) {
                const last7Days = Array.from({length: 7}, (_, i) => {
                    const d = new Date();
                    d.setDate(d.getDate() - (6 - i));
                    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                });

                new Chart(clicksCtx, {
                    type: 'line',
                    data: {
                        labels: last7Days,
                        datasets: [{
                            label: 'Clicks',
                            data: Array(7).fill(0).map((_, i) => Math.floor(Math.random() * 50)),
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            }

            // Device Chart
            const deviceCtx = document.getElementById('deviceChart');
            if (deviceCtx) {
                const allAnalytics = userLinks.flatMap(l => l.analytics || []);
                const devices = allAnalytics.reduce((acc, a) => {
                    acc[a.device] = (acc[a.device] || 0) + 1;
                    return acc;
                }, {});

                new Chart(deviceCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(devices).length > 0 ? Object.keys(devices) : ['Desktop', 'Mobile', 'Tablet'],
                        datasets: [{
                            data: Object.keys(devices).length > 0 ? Object.values(devices) : [45, 35, 20],
                            backgroundColor: ['#667eea', '#764ba2', '#f093fb']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true
                    }
                });
            }
        }

        // ==================== SETTINGS ====================
        function renderSettings() {
            return `
                <div class="max-w-4xl mx-auto fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">
                            <i class="fas fa-cog gradient-bg bg-clip-text text-transparent"></i> Settings
                        </h2>
                        <button onclick="switchToDashboard()" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90 transition">
                            <i class="fas fa-arrow-left mr-2"></i> Back
                        </button>
                    </div>

                    <!-- Branding Settings -->
                    <div class="bg-white rounded-xl shadow-lg p-8 mb-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-palette"></i> Branding
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Brand Name</label>
                                <input type="text" id="brandName" value="${APP_STATE.settings.brandName}" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Brand Color</label>
                                <input type="color" id="brandColor" value="${APP_STATE.settings.brandColor}" class="w-full h-12 border border-gray-300 rounded-lg cursor-pointer">
                            </div>
                        </div>
                    </div>

                    <!-- Account Settings -->
                    <div class="bg-white rounded-xl shadow-lg p-8 mb-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-user-cog"></i> Account Information
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Name</label>
                                <input type="text" value="${APP_STATE.currentUser.name}" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50" readonly>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Email</label>
                                <input type="email" value="${APP_STATE.currentUser.email}" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50" readonly>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Member Since</label>
                                <input type="text" value="${new Date(APP_STATE.currentUser.createdAt).toLocaleDateString()}" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- API Information -->
                    <div class="bg-white rounded-xl shadow-lg p-8">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-code"></i> API Access
                        </h3>
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <p class="text-sm text-gray-600 mb-2">Your API Token:</p>
                            <code class="block bg-gray-800 text-green-400 p-3 rounded font-mono text-sm break-all">${APP_STATE.currentUser.token}</code>
                            <button onclick="copyToClipboard('${APP_STATE.currentUser.token}')" class="mt-3 bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 transition">
                                <i class="fas fa-copy mr-2"></i> Copy Token
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-3">
                            <i class="fas fa-info-circle"></i> Use this token for API integration to programmatically shorten links.
                        </p>
                    </div>

                    <button onclick="saveSettings()" class="mt-6 gradient-bg text-white px-8 py-3 rounded-lg font-semibold hover:opacity-90 transition">
                        <i class="fas fa-save mr-2"></i> Save Settings
                    </button>
                </div>
            `;
        }

        function saveSettings() {
            const brandName = document.getElementById('brandName').value;
            const brandColor = document.getElementById('brandColor').value;

            APP_STATE.settings.brandName = brandName;
            APP_STATE.settings.brandColor = brandColor;
            
            saveToLocalStorage();
            document.getElementById('brandName').textContent = brandName;
            
            showToast('Settings saved successfully!', 'success');
        }

        // ==================== NAVIGATION ====================
        function updateNavigation() {
            const navButtons = document.getElementById('navButtons');
            
            if (APP_STATE.currentUser) {
                navButtons.innerHTML = `
                    <button onclick="switchToDashboard()" class="text-white hover:text-purple-200 transition">
                        <i class="fas fa-th-large mr-1"></i> Dashboard
                    </button>
                    <button onclick="switchToAnalytics()" class="text-white hover:text-purple-200 transition">
                        <i class="fas fa-chart-bar mr-1"></i> Analytics
                    </button>
                    <button onclick="switchToSettings()" class="text-white hover:text-purple-200 transition">
                        <i class="fas fa-cog mr-1"></i> Settings
                    </button>
                    <button onclick="handleLogout()" class="bg-white text-purple-600 px-4 py-2 rounded-lg hover:bg-purple-100 transition">
                        <i class="fas fa-sign-out-alt mr-1"></i> Logout
                    </button>
                `;
            } else {
                navButtons.innerHTML = '';
            }
        }

        function switchToLogin() {
            APP_STATE.currentView = 'login';
            render();
        }

        function switchToSignup() {
            APP_STATE.currentView = 'signup';
            render();
        }

        function switchToDashboard() {
            APP_STATE.currentView = 'dashboard';
            render();
        }

        function switchToAnalytics() {
            APP_STATE.currentView = 'analytics';
            render();
        }

        function switchToSettings() {
            APP_STATE.currentView = 'settings';
            render();
        }

        // ==================== MAIN RENDER ====================
        function render() {
            const app = document.getElementById('app');
            
            if (!APP_STATE.currentUser) {
                if (APP_STATE.currentView === 'signup') {
                    app.innerHTML = renderSignup();
                } else {
                    app.innerHTML = renderLogin();
                }
            } else {
                switch (APP_STATE.currentView) {
                    case 'analytics':
                        app.innerHTML = renderAnalytics();
                        setTimeout(initializeCharts, 100);
                        break;
                    case 'settings':
                        app.innerHTML = renderSettings();
                        break;
                    default:
                        app.innerHTML = renderDashboard();
                }
            }
            
            updateNavigation();
            
            // Add event listener for custom expiry selection
            const expirySelect = document.getElementById('expiryTime');
            if (expirySelect) {
                expirySelect.addEventListener('change', function() {
                    const customContainer = document.getElementById('customExpiryContainer');
                    if (this.value === 'custom') {
                        customContainer.classList.remove('hidden');
                    } else {
                        customContainer.classList.add('hidden');
                    }
                });
            }
        }

        // ==================== INITIALIZATION ====================
        window.addEventListener('DOMContentLoaded', async () => {
            // Auto-login if token exists
            const authToken = localStorage.getItem('authToken');

            if (authToken) {
                try {
                    // Try to fetch user links to verify token is valid
                    const response = await fetch('/api/links', {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            // Token is valid, set current user and fetch links
                            APP_STATE.currentUser = { token: authToken }; // Placeholder, will be updated when needed
                            APP_STATE.links = data.links;
                            APP_STATE.currentView = 'dashboard';
                        }
                    }
                } catch (error) {
                    console.error('Auto-login failed:', error);
                    // Clear invalid token
                    localStorage.removeItem('authToken');
                }
            }

            render();
        });
    </script>
</body>
</html>