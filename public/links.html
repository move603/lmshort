<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Link List - SecureLink</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes gradient {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 200% 200%;
            animation: gradient 15s ease infinite;
        }

        .link-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 4px solid transparent;
        }

        .link-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px -5px rgba(102, 126, 234, 0.3);
            border-left-color: #667eea;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }

        .mobile-menu-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 50;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-out;
        }

        .mobile-menu-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .mobile-menu-content {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: 16rem;
            background-color: white;
            z-index: 60;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            box-shadow: -4px 0 15px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }

        .mobile-menu-content.active {
            transform: translateX(0);
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="gradient-bg text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-link text-3xl"></i>
                    <span class="text-3xl font-bold">SecureLink</span>
                </div>

                <!-- Desktop Menu -->
                <div id="navButtons" class="hidden md:flex space-x-4"></div>

                <!-- Mobile Menu Button -->
                <button id="mobileMenuBtn"
                    class="mobile-menu md:hidden text-white p-2 rounded-lg hover:bg-white hover:bg-opacity-20 transition"
                    aria-label="Open mobile menu">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </div>
        </div>

        <!-- Mobile Menu Overlay -->
        <div id="mobileMenuOverlay" class="mobile-menu-overlay">
            <div class="mobile-menu-content">
                <div class="flex justify-between items-center mb-8">
                    <h3 class="text-xl font-bold text-gray-800">Menu</h3>
                    <button id="closeMobileMenu" class="text-gray-500 hover:text-gray-700" aria-label="Close mobile menu">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <div id="mobileNavButtons" class="flex flex-col space-y-4"></div>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div id="app" class="container mx-auto px-4 py-8"></div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-3"></div>

    <script>
        // Global state
        let currentUser = null;
        let links = [];
        let selectedLinkIds = new Set();
        let currentFilter = 'all';
        let searchQuery = '';

        // Utility functions
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500',
                warning: 'bg-yellow-500'
            };
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                info: 'fa-info-circle',
                warning: 'fa-exclamation-triangle'
            };

            toast.className = `${colors[type]} px-6 py-4 rounded-xl shadow-2xl text-white flex items-center space-x-3 min-w-[300px]`;
            toast.innerHTML = `
                <i class="fas ${icons[type]} text-2xl"></i>
                <span class="font-semibold">${message}</span>
            `;

            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        function checkExpiry(link) {
            if (!link.expiryTime) return false;
            return new Date() > new Date(link.expiryTime);
        }

        async function loadUserLinks() {
            console.log('ðŸ“‹ Loading user links...');
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    console.error('âŒ No auth token found');
                    window.location.href = '/login';
                    return;
                }

                console.log('ðŸ”‘ Token found, fetching links...');
                const response = await fetch('/api/links', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                console.log('ðŸ“¡ Response status:', response.status);

                if (response.ok) {
                    const data = await response.json();
                    console.log('âœ… Data received:', data);

                    if (data.success) {
                        links = data.links || [];
                        console.log(`ðŸ“Š Loaded ${links.length} links`);
                        render();
                    } else {
                        console.error('âŒ API returned success:false', data);
                        showToast('Failed to load links', 'error');
                    }
                } else if (response.status === 401) {
                    console.error('âŒ Unauthorized - clearing token');
                    localStorage.removeItem('authToken');
                    window.location.href = '/login';
                } else {
                    const errorText = await response.text();
                    console.error('âŒ API error:', response.status, errorText);
                    showToast(`Failed to load links (${response.status})`, 'error');
                }
            } catch (error) {
                console.error('ðŸ’¥ Error loading links:', error);
                showToast('Failed to load links: ' + error.message, 'error');
            }
        }

        async function deleteLink(id) {
            if (!confirm('Are you sure you want to delete this link?')) return;

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`/api/links?id=${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    links = links.filter(l => l.id !== id);
                    selectedLinkIds.delete(id);
                    showToast('Link deleted successfully', 'info');
                    render();
                } else {
                    throw new Error('Failed to delete link');
                }
            } catch (error) {
                showToast('Failed to delete link', 'error');
            }
        }

        async function deleteSelectedLinks() {
            if (selectedLinkIds.size === 0) {
                showToast('No links selected', 'error');
                return;
            }

            const count = selectedLinkIds.size;
            const confirmed = confirm(`âš ï¸ Are you sure you want to delete ${count} selected link${count > 1 ? 's' : ''}?\n\nThis action cannot be undone!`);

            if (!confirmed) return;

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch('/api/links?action=bulk-delete', {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ linkIds: Array.from(selectedLinkIds) })
                });

                if (response.ok) {
                    const result = await response.json();
                    links = links.filter(l => !selectedLinkIds.has(l.id));
                    selectedLinkIds.clear();
                    showToast(`Successfully deleted ${result.deleted} link${result.deleted > 1 ? 's' : ''}! ðŸ—‘ï¸`, 'success');
                    render();
                } else {
                    throw new Error('Bulk delete failed');
                }
            } catch (error) {
                showToast('Failed to delete selected links', 'error');
                console.error('Delete error:', error);
            }
        }

        function copyLink(url) {
            navigator.clipboard.writeText(url).then(() => {
                showToast('Copied to clipboard! âœ“', 'success');
            }).catch(() => {
                showToast('Failed to copy', 'error');
            });
        }

        function showQRCode(shortCode) {
            const shortUrl = `${window.location.origin}/${shortCode}`;

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-3xl p-10 max-w-md w-full mx-4 shadow-2xl fade-in">
                    <div class="text-center">
                        <h3 class="text-3xl font-bold text-gray-800 mb-6 flex items-center justify-center">
                            <i class="fas fa-qrcode gradient-bg bg-clip-text text-transparent mr-3"></i>
                            QR Code
                        </h3>
                        <div id="qrcodeContainer" class="flex justify-center mb-6 p-4 bg-gray-50 rounded-2xl"></div>
                        <p class="text-sm text-gray-600 mb-6 break-all font-mono bg-purple-50 p-3 rounded-lg">${shortUrl}</p>
                        <div class="flex space-x-3">
                            <button onclick="downloadQRCode('${shortCode}')" class="flex-1 gradient-bg text-white px-6 py-3 rounded-xl font-bold hover:shadow-xl transition">
                                <i class="fas fa-download mr-2"></i> Download
                            </button>
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 text-white px-6 py-3 rounded-xl font-bold hover:bg-gray-600 transition">
                                <i class="fas fa-times mr-2"></i> Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Generate QR code
            new QRCode(document.getElementById('qrcodeContainer'), {
                text: shortUrl,
                width: 256,
                height: 256,
                colorDark: '#667eea',
                colorLight: '#ffffff'
            });
        }

        function downloadQRCode(shortCode) {
            const canvas = document.querySelector('#qrcodeContainer canvas');
            if (canvas) {
                const link = document.createElement('a');
                link.download = `qrcode-${shortCode}.png`;
                link.href = canvas.toDataURL();
                link.click();
                showToast('QR Code downloaded!', 'success');
            }
        }

        function toggleLinkSelection(linkId, isChecked) {
            if (isChecked) {
                selectedLinkIds.add(linkId);
            } else {
                selectedLinkIds.delete(linkId);
            }
            updateDeleteButton();
        }

        function toggleSelectAll(isChecked) {
            const filteredLinks = getFilteredLinks();
            if (isChecked) {
                filteredLinks.forEach(link => selectedLinkIds.add(link.id));
            } else {
                filteredLinks.forEach(link => selectedLinkIds.delete(link.id));
            }
            render();
        }

        function updateDeleteButton() {
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            const countSpan = document.getElementById('selectedCount');

            if (deleteBtn && countSpan) {
                countSpan.textContent = selectedLinkIds.size;

                if (selectedLinkIds.size > 0) {
                    deleteBtn.classList.remove('hidden');
                } else {
                    deleteBtn.classList.add('hidden');
                }
            }
        }

        function getFilteredLinks() {
            let filtered = links;

            // Apply status filter
            switch (currentFilter) {
                case 'active':
                    filtered = filtered.filter(l => !checkExpiry(l));
                    break;
                case 'expired':
                    filtered = filtered.filter(l => checkExpiry(l));
                    break;
                case 'protected':
                    filtered = filtered.filter(l => l.password);
                    break;
            }

            // Apply search
            if (searchQuery) {
                const query = searchQuery.toLowerCase();
                filtered = filtered.filter(l =>
                    l.title?.toLowerCase().includes(query) ||
                    l.originalUrl.toLowerCase().includes(query) ||
                    l.shortCode.toLowerCase().includes(query)
                );
            }

            return filtered;
        }

        function exportLinks() {
            const filteredLinks = getFilteredLinks();
            const csvContent = [
                ['Title', 'Short URL', 'Original URL', 'Clicks', 'Created', 'Expires', 'Status'],
                ...filteredLinks.map(link => [
                    link.title || '',
                    `${window.location.origin}/${link.shortCode}`,
                    link.originalUrl,
                    link.clicks || 0,
                    new Date(link.createdAt).toLocaleDateString(),
                    link.expiryTime ? new Date(link.expiryTime).toLocaleDateString() : 'Never',
                    checkExpiry(link) ? 'Expired' : 'Active'
                ])
            ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'links-export.csv';
            a.click();
            window.URL.revokeObjectURL(url);
            showToast('Links exported successfully!', 'success');
        }

        function render() {
            const filteredLinks = getFilteredLinks();
            const activeLinks = links.filter(l => !checkExpiry(l));
            const expiredLinks = links.filter(l => checkExpiry(l));
            const protectedLinks = links.filter(l => l.password);

            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="fade-in">
                    <!-- Header -->
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
                        <div>
                            <h1 class="text-4xl font-bold text-gray-800 mb-2 flex items-center">
                                <i class="fas fa-list gradient-bg bg-clip-text text-transparent mr-3"></i>
                                Your Links
                            </h1>
                            <p class="text-gray-600">Manage and organize all your shortened links</p>
                        </div>
                        <div class="flex space-x-3 mt-4 md:mt-0">
                            <button onclick="exportLinks()" class="bg-green-500 text-white px-6 py-3 rounded-xl hover:bg-green-600 transition font-semibold shadow-lg">
                                <i class="fas fa-download mr-2"></i> Export
                            </button>
                            <a href="/" class="gradient-bg text-white px-6 py-3 rounded-xl hover:shadow-xl transition font-semibold">
                                <i class="fas fa-plus mr-2"></i> Create New
                            </a>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-2 mobile:grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 mb-8">
                        <div class="bg-gradient-to-br from-blue-500 to-blue-700 rounded-2xl shadow-xl p-4 md:p-6 text-white mobile-card-spacing">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <p class="text-blue-100 text-xs md:text-sm font-semibold">Total Links</p>
                                    <p class="text-2xl md:text-4xl font-bold mt-1 md:mt-2">${links.length}</p>
                                </div>
                                <i class="fas fa-link text-3xl md:text-5xl opacity-30"></i>
                            </div>
                        </div>

                        <div class="bg-gradient-to-br from-green-500 to-green-700 rounded-2xl shadow-xl p-4 md:p-6 text-white mobile-card-spacing">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <p class="text-green-100 text-xs md:text-sm font-semibold">Active Links</p>
                                    <p class="text-2xl md:text-4xl font-bold mt-1 md:mt-2">${activeLinks.length}</p>
                                </div>
                                <i class="fas fa-check-circle text-3xl md:text-5xl opacity-30"></i>
                            </div>
                        </div>

                        <div class="bg-gradient-to-br from-red-500 to-red-700 rounded-2xl shadow-xl p-4 md:p-6 text-white mobile-card-spacing">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <p class="text-red-100 text-xs md:text-sm font-semibold">Expired</p>
                                    <p class="text-2xl md:text-4xl font-bold mt-1 md:mt-2">${expiredLinks.length}</p>
                                </div>
                                <i class="fas fa-clock text-3xl md:text-5xl opacity-30"></i>
                            </div>
                        </div>

                        <div class="bg-gradient-to-br from-yellow-500 to-yellow-700 rounded-2xl shadow-xl p-4 md:p-6 text-white mobile-card-spacing">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <p class="text-yellow-100 text-xs md:text-sm font-semibold">Protected</p>
                                    <p class="text-2xl md:text-4xl font-bold mt-1 md:mt-2">${protectedLinks.length}</p>
                                </div>
                                <i class="fas fa-lock text-3xl md:text-5xl opacity-30"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Filters and Search -->
                    <div class="bg-white rounded-2xl shadow-xl p-4 md:p-6 mb-8">
                        <div class="flex flex-col gap-4">
                            <div class="w-full">
                                <input
                                    type="text"
                                    id="searchInput"
                                    placeholder="Search links..."
                                    value="${searchQuery}"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent mobile-text-base"
                                    oninput="searchQuery = this.value; render()"
                                >
                            </div>
                            <div class="flex flex-wrap gap-2 mobile-btn-group">
                                <button onclick="setFilter('all')" class="flex-1 min-w-[120px] px-3 py-3 rounded-lg font-semibold transition mobile-nav-btn ${currentFilter === 'all' ? 'gradient-bg text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                                    All (${links.length})
                                </button>
                                <button onclick="setFilter('active')" class="flex-1 min-w-[120px] px-3 py-3 rounded-lg font-semibold transition mobile-nav-btn ${currentFilter === 'active' ? 'gradient-bg text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                                    Active (${activeLinks.length})
                                </button>
                                <button onclick="setFilter('expired')" class="flex-1 min-w-[120px] px-3 py-3 rounded-lg font-semibold transition mobile-nav-btn ${currentFilter === 'expired' ? 'gradient-bg text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                                    Expired (${expiredLinks.length})
                                </button>
                                <button onclick="setFilter('protected')" class="flex-1 min-w-[120px] px-3 py-3 rounded-lg font-semibold transition mobile-nav-btn ${currentFilter === 'protected' ? 'gradient-bg text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                                    Protected (${protectedLinks.length})
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Bulk Actions -->
                    <div class="mb-6">
                        <button id="deleteSelectedBtn" onclick="deleteSelectedLinks()" class="hidden bg-red-500 text-white px-6 py-3 rounded-xl hover:bg-red-600 transition-all font-bold shadow-lg">
                            <i class="fas fa-trash-alt mr-2"></i> Delete Selected (<span id="selectedCount">0</span>)
                        </button>
                    </div>

                    <!-- Links List -->
                    <div class="bg-white rounded-2xl shadow-xl p-8">
                        ${renderLinksList(filteredLinks)}
                    </div>
                </div>
            `;

            updateDeleteButton();
        }

        function setFilter(filter) {
            currentFilter = filter;
            selectedLinkIds.clear();
            render();
        }

        function renderLinksList(links) {
            if (links.length === 0) {
                return `
                    <div class="text-center py-16">
                        <i class="fas fa-inbox text-gray-300 text-8xl mb-4"></i>
                        <p class="text-2xl text-gray-500 font-semibold mb-2">No links found</p>
                        <p class="text-gray-400">Try adjusting your search or filter criteria.</p>
                        <a href="/" class="inline-block mt-6 gradient-bg text-white px-6 py-3 rounded-lg font-semibold hover:shadow-lg transition">
                            <i class="fas fa-plus mr-2"></i> Create Link
                        </a>
                    </div>
                `;
            }

            const selectAllChecked = selectedLinkIds.size === links.length && links.length > 0;

            return `
                <!-- Select All Checkbox -->
                <div class="flex items-center justify-between p-5 bg-purple-50 rounded-xl mb-4 border-2 border-purple-300 shadow-sm">
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input
                            type="checkbox"
                            id="selectAll"
                            ${selectAllChecked ? 'checked' : ''}
                            onchange="toggleSelectAll(this.checked)"
                            class="w-6 h-6 text-purple-600 rounded focus:ring-2 focus:ring-purple-500 cursor-pointer"
                        >
                        <span class="font-bold text-purple-900 text-lg">
                            <i class="fas fa-check-double mr-2"></i>Select All Links
                        </span>
                    </label>
                    <span class="text-sm text-purple-800 font-bold bg-purple-200 px-4 py-2 rounded-full">
                        ${selectedLinkIds.size} of ${links.length} selected
                    </span>
                </div>

                <!-- Links -->
                <div class="space-y-4 custom-scrollbar max-h-[800px] overflow-y-auto">
                    ${links.map(link => {
                const isExpired = checkExpiry(link);
                const shortUrl = `${window.location.origin}/${link.shortCode}`;
                const isSelected = selectedLinkIds.has(link.id);

                return `
                            <div class="border-2 ${isSelected ? 'border-purple-500 bg-purple-50 shadow-lg' : 'border-gray-200 bg-white'} rounded-xl p-5 link-card ${isExpired ? 'opacity-60' : ''} transition-all duration-300">
                                <div class="flex items-start space-x-4">
                                    <!-- Checkbox -->
                                    <input
                                        type="checkbox"
                                        ${isSelected ? 'checked' : ''}
                                        onchange="toggleLinkSelection('${link.id}', this.checked)"
                                        class="w-6 h-6 mt-1 text-purple-600 rounded focus:ring-2 focus:ring-purple-500 cursor-pointer flex-shrink-0"
                                    >

                                    <!-- Link Content -->
                                    <div class="flex-1 min-w-0">
                                        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center space-y-4 lg:space-y-0">
                                            <div class="flex-1">
                                                <div class="flex items-center space-x-3 mb-2 flex-wrap">
                                                    ${link.title ? `<h4 class="font-bold text-lg text-gray-800">${link.title}</h4>` : ''}
                                                    ${isExpired ? '<span class="bg-red-500 text-white px-3 py-1 rounded-full text-xs font-bold">Expired</span>' : '<span class="bg-green-500 text-white px-3 py-1 rounded-full text-xs font-bold">Active</span>'}
                                                    ${link.password ? '<i class="fas fa-lock text-yellow-600 text-xl" title="Password Protected"></i>' : ''}
                                                </div>
                                                <p class="text-base text-purple-600 font-semibold mb-1 break-all">
                                                    <i class="fas fa-link mr-1"></i> ${shortUrl}
                                                </p>
                                                <p class="text-sm text-gray-500 break-all mb-2">
                                                    <i class="fas fa-external-link-alt mr-1"></i> ${link.originalUrl}
                                                </p>
                                                <div class="flex items-center space-x-4 text-sm text-gray-600 flex-wrap">
                                                    <span class="font-semibold"><i class="fas fa-mouse-pointer text-purple-600"></i> ${link.clicks || 0} clicks</span>
                                                    <span><i class="fas fa-calendar text-blue-600"></i> ${new Date(link.createdAt).toLocaleDateString()}</span>
                                                    ${link.expiryTime ? `<span><i class="fas fa-clock text-orange-600"></i> Expires: ${new Date(link.expiryTime).toLocaleString()}</span>` : '<span><i class="fas fa-infinity text-green-600"></i> No expiry</span>'}
                                                </div>
                                            </div>

                                            <div class="flex items-center space-x-2 flex-wrap gap-2">
                                                <button onclick="copyLink('${shortUrl}')" class="flex-1 min-w-[44px] bg-blue-500 hover:bg-blue-600 text-white px-3 py-3 rounded-lg transition font-semibold shadow-md mobile-btn" title="Copy Link" aria-label="Copy link to clipboard">
                                                    <i class="fas fa-copy"></i><span class="hidden md:inline ml-1">Copy</span>
                                                </button>
                                                <button onclick="showQRCode('${link.shortCode}')" class="flex-1 min-w-[44px] bg-purple-500 hover:bg-purple-600 text-white px-3 py-3 rounded-lg transition font-semibold shadow-md mobile-btn" title="QR Code" aria-label="Generate QR code">
                                                    <i class="fas fa-qrcode"></i><span class="hidden md:inline ml-1">QR</span>
                                                </button>
                                                <button onclick="deleteLink('${link.id}')" class="flex-1 min-w-[44px] bg-red-500 hover:bg-red-600 text-white px-3 py-3 rounded-lg transition font-semibold shadow-md mobile-btn" title="Delete" aria-label="Delete link">
                                                    <i class="fas fa-trash"></i><span class="hidden md:inline ml-1">Delete</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
            }).join('')}
                </div>
            `;
        }

        function updateNav() {
            const nav = document.getElementById('navButtons');
            const mobileNav = document.getElementById('mobileNavButtons');

            if (currentUser) {
                const linksHtml = `
                    <a href="/?view=dashboard" class="text-white hover:text-purple-200 transition flex items-center">
                        <i class="fas fa-th-large mr-1"></i> Dashboard
                    </a>
                    <span class="bg-white bg-opacity-20 text-white px-3 py-2 rounded-lg font-bold flex items-center shadow-inner">
                        <i class="fas fa-list mr-1"></i> Link List
                    </span>
                    <a href="/?view=analytics" class="text-white hover:text-purple-200 transition flex items-center">
                        <i class="fas fa-chart-bar mr-1"></i> Analytics
                    </a>
                    <a href="/?view=settings" class="text-white hover:text-purple-200 transition flex items-center">
                        <i class="fas fa-cog mr-1"></i> Settings
                    </a>
                    <button onclick="handleLogout()" class="bg-white text-purple-600 px-4 py-2 rounded-lg font-bold hover:bg-purple-100 transition flex items-center ml-2 shadow-sm">
                        <i class="fas fa-sign-out-alt mr-1"></i> Logout
                    </button>
                `;

                const mobileLinksHtml = `
                    <a href="/?view=dashboard" class="text-gray-700 hover:bg-purple-50 px-4 py-3 rounded-lg transition flex items-center">
                        <i class="fas fa-th-large mr-3 text-purple-600"></i> Dashboard
                    </a>
                    <span class="bg-purple-100 text-purple-800 px-4 py-3 rounded-lg font-bold flex items-center">
                        <i class="fas fa-list mr-3"></i> Link List
                    </span>
                    <a href="/?view=analytics" class="text-gray-700 hover:bg-purple-50 px-4 py-3 rounded-lg transition flex items-center">
                        <i class="fas fa-chart-bar mr-3 text-purple-600"></i> Analytics
                    </a>
                    <a href="/?view=settings" class="text-gray-700 hover:bg-purple-50 px-4 py-3 rounded-lg transition flex items-center">
                        <i class="fas fa-cog mr-3 text-purple-600"></i> Settings
                    </a>
                    <button onclick="handleLogout()" class="text-red-600 hover:bg-red-50 px-4 py-3 rounded-lg transition flex items-center w-full text-left">
                        <i class="fas fa-sign-out-alt mr-3"></i> Logout
                    </button>
                `;


                nav.innerHTML = linksHtml;
                if (mobileNav) mobileNav.innerHTML = mobileLinksHtml;
            } else {
                const linksHtml = `
                    <a href="/" class="text-white hover:text-purple-200 transition">
                        <i class="fas fa-home mr-1"></i> Home
                    </a>
                `;
                nav.innerHTML = linksHtml;
                if (mobileNavButtons) mobileNavButtons.innerHTML = linksHtml.replace('text-white', 'text-gray-800');
            }

            // Add mobile menu event listeners
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
            const closeMobileMenuBtn = document.getElementById('closeMobileMenu');

            if (mobileMenuBtn) {
                mobileMenuBtn.addEventListener('click', toggleMobileMenu);
            }

            if (closeMobileMenuBtn) {
                closeMobileMenuBtn.addEventListener('click', closeMobileMenu);
            }

            if (mobileMenuOverlay) {
                mobileMenuOverlay.addEventListener('click', function (e) {
                    if (e.target === mobileMenuOverlay) {
                        closeMobileMenu();
                    }
                });
            }
        }

        function initMobileMenu() {
            const btn = document.getElementById('mobileMenuBtn');
            const closeBtn = document.getElementById('closeMobileMenu');
            const overlay = document.getElementById('mobileMenuOverlay');
            const content = document.getElementById('mobileMenuContent');

            function openMenu() {
                overlay.classList.remove('hidden');
                // Trigger reflow
                void overlay.offsetWidth;
                overlay.classList.remove('opacity-0');
                content.classList.remove('translate-x-full');
            }

            function closeMenu() {
                overlay.classList.add('opacity-0');
                content.classList.add('translate-x-full');
                setTimeout(() => {
                    overlay.classList.add('hidden');
                }, 300);
            }

            if (btn) btn.onclick = openMenu;
            if (closeBtn) closeBtn.onclick = closeMenu;
            if (overlay) overlay.onclick = (e) => {
                if (e.target === overlay) closeMenu();
            };
        }

        function handleLogout() {
            currentUser = null;
            localStorage.removeItem('authToken');
            links = [];
            selectedLinkIds.clear();
            showToast('Logged out successfully', 'info');
            window.location.href = '/login';
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('ðŸš€ SecureLink Links Page loading...');

            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = '/login';
                return;
            }

            try {
                // Get user data
                const userResponse = await fetch('/api/auth?type=me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (userResponse.ok) {
                    const userData = await userResponse.json();
                    if (userData.success) {
                        currentUser = userData.user;
                        updateNav();
                        await loadUserLinks();
                    }
                } else {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('Auto-login failed:', error);
                localStorage.removeItem('authToken');
                window.location.href = '/login';
            }
        });
    </script>
</body>

</html>